<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>2주차 - Observability(Hubble, Prometheus/Grafana)</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
	margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(50, 48, 44, 1);
}
.highlight-gray {
	color: rgba(115, 114, 110, 1);
	fill: rgba(115, 114, 110, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(205, 60, 58, 1);
	fill: rgba(205, 60, 58, 1);
}
.highlight-default_background {
	color: rgba(50, 48, 44, 1);
}
.highlight-gray_background {
	background: rgba(248, 248, 247, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(248, 243, 252, 1);
}
.highlight-pink_background {
	background: rgba(252, 241, 246, 1);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(115, 114, 110, 1);
	fill: rgba(115, 114, 110, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(205, 60, 58, 1);
	fill: rgba(205, 60, 58, 1);
}
.block-color-default_background {
	color: inherit;
	fill: inherit;
}
.block-color-gray_background {
	background: rgba(248, 248, 247, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(248, 243, 252, 1);
}
.block-color-pink_background {
	background: rgba(252, 241, 246, 1);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-default { background-color: rgba(84, 72, 49, 0.08); }
.select-value-color-gray { background-color: rgba(84, 72, 49, 0.15); }
.select-value-color-brown { background-color: rgba(210, 162, 141, 0.35); }
.select-value-color-orange { background-color: rgba(224, 124, 57, 0.27); }
.select-value-color-yellow { background-color: rgba(236, 191, 66, 0.39); }
.select-value-color-green { background-color: rgba(123, 183, 129, 0.27); }
.select-value-color-blue { background-color: rgba(93, 165, 206, 0.27); }
.select-value-color-purple { background-color: rgba(168, 129, 197, 0.27); }
.select-value-color-pink { background-color: rgba(225, 136, 179, 0.27); }
.select-value-color-red { background-color: rgba(244, 171, 159, 0.4); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="23bb8b2c-1c23-80f1-bff8-de2101fb750a" class="page sans"><header><h1 class="page-title">2주차 - Observability(Hubble, Prometheus/Grafana)</h1><p class="page-description"></p></header><div class="page-body"><p id="23bb8b2c-1c23-8094-80e5-df4f3722c893" class="">
</p><ol type="1" id="23bb8b2c-1c23-806c-839b-db9a66df8446" class="numbered-list" start="0"><li>실습 환경 소개<ul id="23bb8b2c-1c23-8052-bac8-dcf6c97fee16" class="bulleted-list"><li style="list-style-type:disc"><strong>실습 환경 소개</strong><figure id="23bb8b2c-1c23-801c-807f-d469e79ebf08" class="image"><a href="images/cilium-2w.png"><img style="width:624px" src="images/cilium-2w.png"/></a></figure><ul id="23bb8b2c-1c23-80a3-8a9f-cb3d45417d2e" class="bulleted-list"><li style="list-style-type:circle">기본 배포 가상 머신 : k8s-ctr, k8s-w1, k8s-w2</li></ul><ul id="23bb8b2c-1c23-8068-85d0-df503f170c28" class="bulleted-list"><li style="list-style-type:circle">초기 프로비저닝으로 kubeadm init 과 join 실행됨</li></ul><ul id="23bb8b2c-1c23-8022-b095-c3884d4b384d" class="bulleted-list"><li style="list-style-type:circle">Cilium CNI 설치 상태로 배포 완료됨</li></ul></li></ul><p id="23bb8b2c-1c23-802b-9dc3-caba7821b056" class="">
</p><ul id="23bb8b2c-1c23-80a3-995d-ce01d2be9aeb" class="bulleted-list"><li style="list-style-type:disc"><strong>실습 환경 배포 파일 작성</strong><ul id="23bb8b2c-1c23-8005-900d-cc51686c2961" class="toggle"><li><details open=""><summary>Vagrantfile : 가상머신 정의, 부팅 시 초기 프로비저닝 설정</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8087-90ea-db0f90b9e5b4" class="code"><code class="language-Bash"># Variables
K8SV = &#x27;1.33.2-1.1&#x27; # Kubernetes Version : apt list -a kubelet , ex) 1.32.5-1.1
CONTAINERDV = &#x27;1.7.27-1&#x27; # Containerd Version : apt list -a containerd.io , ex) 1.6.33-1
CILIUMV = &#x27;1.17.6&#x27; # Cilium CNI Version : https://github.com/cilium/cilium/tags
N = 2 # max number of worker nodes

# Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04
BOX_IMAGE = &quot;bento/ubuntu-24.04&quot;
BOX_VERSION = &quot;202502.21.0&quot;

Vagrant.configure(&quot;2&quot;) do |config|
#-ControlPlane Node
    config.vm.define &quot;k8s-ctr&quot; do |subconfig|
      subconfig.vm.box = BOX_IMAGE
      
      subconfig.vm.box_version = BOX_VERSION
      subconfig.vm.provider &quot;virtualbox&quot; do |vb|
        vb.customize [&quot;modifyvm&quot;, :id, &quot;--groups&quot;, &quot;/Cilium-Lab&quot;]
        vb.customize [&quot;modifyvm&quot;, :id, &quot;--nicpromisc2&quot;, &quot;allow-all&quot;]
        vb.name = &quot;k8s-ctr&quot;
        vb.cpus = 2
        vb.memory = 2048
        vb.linked_clone = true
      end
      subconfig.vm.host_name = &quot;k8s-ctr&quot;
      subconfig.vm.network &quot;private_network&quot;, ip: &quot;192.168.10.100&quot;
      subconfig.vm.network &quot;forwarded_port&quot;, guest: 22, host: 60000, auto_correct: true, id: &quot;ssh&quot;
      subconfig.vm.synced_folder &quot;./&quot;, &quot;/vagrant&quot;, disabled: true
      subconfig.vm.provision &quot;shell&quot;, path: &quot;init_cfg.sh&quot;, args: [ K8SV, CONTAINERDV ]
      subconfig.vm.provision &quot;shell&quot;, path: &quot;k8s-ctr.sh&quot;, args: [ N, CILIUMV ]
    end

#-Worker Nodes Subnet1
  (1..N).each do |i|
    config.vm.define &quot;k8s-w#{i}&quot; do |subconfig|
      subconfig.vm.box = BOX_IMAGE
      subconfig.vm.box_version = BOX_VERSION
      subconfig.vm.provider &quot;virtualbox&quot; do |vb|
        vb.customize [&quot;modifyvm&quot;, :id, &quot;--groups&quot;, &quot;/Cilium-Lab&quot;]
        vb.customize [&quot;modifyvm&quot;, :id, &quot;--nicpromisc2&quot;, &quot;allow-all&quot;]
        vb.name = &quot;k8s-w#{i}&quot;
        vb.cpus = 2
        vb.memory = 1536
        vb.linked_clone = true
      end
      subconfig.vm.host_name = &quot;k8s-w#{i}&quot;
      subconfig.vm.network &quot;private_network&quot;, ip: &quot;192.168.10.10#{i}&quot;
      subconfig.vm.network &quot;forwarded_port&quot;, guest: 22, host: &quot;6000#{i}&quot;, auto_correct: true, id: &quot;ssh&quot;
      subconfig.vm.synced_folder &quot;./&quot;, &quot;/vagrant&quot;, disabled: true
      subconfig.vm.provision &quot;shell&quot;, path: &quot;init_cfg.sh&quot;, args: [ K8SV, CONTAINERDV]
      subconfig.vm.provision &quot;shell&quot;, path: &quot;k8s-w.sh&quot;
    end
  end

end
</code></pre><p id="23bb8b2c-1c23-80e9-9d7b-c43e76cc9b6a" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-806f-ba86-cdcf3ce0de51" class="toggle"><li><details open=""><summary>init_cfg.sh : args 참고하여 설치</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80ed-8bff-c3f10a52bd3d" class="code"><code class="language-Bash">#!/usr/bin/env bash

echo &quot;&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;&quot;

echo &quot;[TASK 1] Setting Profile &amp; Bashrc&quot;
echo &#x27;alias vi=vim&#x27; &gt;&gt; /etc/profile
echo &quot;sudo su -&quot; &gt;&gt; /home/vagrant/.bashrc
ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime # Change Timezone


echo &quot;[TASK 2] Disable AppArmor&quot;
systemctl stop ufw &amp;&amp; systemctl disable ufw &gt;/dev/null 2&gt;&amp;1
systemctl stop apparmor &amp;&amp; systemctl disable apparmor &gt;/dev/null 2&gt;&amp;1


echo &quot;[TASK 3] Disable and turn off SWAP&quot;
swapoff -a &amp;&amp; sed -i &#x27;/swap/s/^/#/&#x27; /etc/fstab


echo &quot;[TASK 4] Install Packages&quot;
apt update -qq &gt;/dev/null 2&gt;&amp;1
apt-get install apt-transport-https ca-certificates curl gpg -y -qq &gt;/dev/null 2&gt;&amp;1

# Download the public signing key for the Kubernetes package repositories.
mkdir -p -m 755 /etc/apt/keyrings
K8SMMV=$(echo $1 | sed -En &#x27;s/^([0-9]+\.[0-9]+)\..*/\1/p&#x27;)
curl -fsSL https://pkgs.k8s.io/core:/stable:/v$K8SMMV/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo &quot;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v$K8SMMV/deb/ /&quot; &gt;&gt; /etc/apt/sources.list.d/kubernetes.list
curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
echo &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release &amp;&amp; echo &quot;$VERSION_CODENAME&quot;) stable&quot; | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null

# packets traversing the bridge are processed by iptables for filtering
echo 1 &gt; /proc/sys/net/ipv4/ip_forward
echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.d/k8s.conf

# enable br_netfilter for iptables 
modprobe br_netfilter
modprobe overlay
echo &quot;br_netfilter&quot; &gt;&gt; /etc/modules-load.d/k8s.conf
echo &quot;overlay&quot; &gt;&gt; /etc/modules-load.d/k8s.conf


echo &quot;[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)&quot;
# Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version
apt update &gt;/dev/null 2&gt;&amp;1

# apt list -a kubelet ; apt list -a containerd.io
apt-get install -y kubelet=$1 kubectl=$1 kubeadm=$1 containerd.io=$2 &gt;/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl &gt;/dev/null 2&gt;&amp;1

# containerd configure to default and cgroup managed by systemd
containerd config default &gt; /etc/containerd/config.toml
sed -i &#x27;s/SystemdCgroup = false/SystemdCgroup = true/g&#x27; /etc/containerd/config.toml

# avoid WARN&amp;ERRO(default endpoints) when crictl run  
cat &lt;&lt;EOF &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
EOF

# ready to install for k8s 
systemctl restart containerd &amp;&amp; systemctl enable containerd
systemctl enable --now kubelet


echo &quot;[TASK 6] Install Packages &amp; Helm&quot;
export DEBIAN_FRONTEND=noninteractive
apt-get install -y bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq tree bash-completion unzip kubecolor termshark &gt;/dev/null 2&gt;&amp;1
curl -s https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash &gt;/dev/null 2&gt;&amp;1


echo &quot;&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;&quot;
</code></pre><p id="23bb8b2c-1c23-8000-8c03-da13ecdf5d5f" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-809d-b668-e71e510aa8f1" class="toggle"><li><details open=""><summary>k8s-ctr.sh : kubeadm init, Cilium CNI 설치, 편리성 설정(k, kc)</summary><ul id="23bb8b2c-1c23-80fa-92f7-e4bdcff5a861" class="toggle"><li><details open=""><summary>kubeadm-init-ctr-config.yaml<em><mark class="highlight-gray"> ⇒ ‘kubernetesVersion: v1.33.2’ 기본 설정 변수 값 받을 수 있게 수정 해둘것!</mark></em></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80e5-bf85-c33dcf35794d" class="code"><code class="language-Bash">apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration
bootstrapTokens:
- token: &quot;123456.1234567890123456&quot;
  ttl: &quot;0s&quot;
  usages:
  - signing
  - authentication
localAPIEndpoint:
  advertiseAddress: &quot;192.168.10.100&quot;
nodeRegistration:
  kubeletExtraArgs:
    - name: node-ip
      value: &quot;192.168.10.100&quot;
  criSocket: &quot;unix:///run/containerd/containerd.sock&quot;
---
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
kubernetesVersion: v1.33.2
networking:
  podSubnet: &quot;10.244.0.0/16&quot;
  serviceSubnet: &quot;10.96.0.0/16&quot;
# kube-proxy를 설치하지 않도록 설정!
proxy:
  disabled: true</code></pre><p id="23bb8b2c-1c23-8093-9e68-e85f9eea5324" class="">
</p></details></li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8035-98b0-f2cb6bd7c535" class="code"><code class="language-Bash">#!/usr/bin/env bash

echo &quot;&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;&quot;

echo &quot;[TASK 1] Initial Kubernetes&quot;
curl --silent -o /root/kubeadm-init-ctr-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-init-ctr-config.yaml
kubeadm init --config=&quot;/root/kubeadm-init-ctr-config.yaml&quot; --skip-phases=addon/kube-proxy  &gt;/dev/null 2&gt;&amp;1


echo &quot;[TASK 2] Setting kube config file&quot;
mkdir -p /root/.kube
cp -i /etc/kubernetes/admin.conf /root/.kube/config
chown $(id -u):$(id -g) /root/.kube/config


echo &quot;[TASK 3] Source the completion&quot;
echo &#x27;source &lt;(kubectl completion bash)&#x27; &gt;&gt; /etc/profile
echo &#x27;source &lt;(kubeadm completion bash)&#x27; &gt;&gt; /etc/profile


echo &quot;[TASK 4] Alias kubectl to k&quot;
echo &#x27;alias k=kubectl&#x27; &gt;&gt; /etc/profile
echo &#x27;alias kc=kubecolor&#x27; &gt;&gt; /etc/profile
echo &#x27;complete -F __start_kubectl k&#x27; &gt;&gt; /etc/profile


echo &quot;[TASK 5] Install Kubectx &amp; Kubens&quot;
git clone https://github.com/ahmetb/kubectx /opt/kubectx &gt;/dev/null 2&gt;&amp;1
ln -s /opt/kubectx/kubens /usr/local/bin/kubens
ln -s /opt/kubectx/kubectx /usr/local/bin/kubectx


echo &quot;[TASK 6] Install Kubeps &amp; Setting PS1&quot;
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 &gt;/dev/null 2&gt;&amp;1
cat &lt;&lt;&quot;EOT&quot; &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo &quot;$1&quot; | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=&#x27;) &#x27;
PS1=&#x27;$(kube_ps1)&#x27;$PS1
EOT
kubectl config rename-context &quot;kubernetes-admin@kubernetes&quot; &quot;HomeLab&quot; &gt;/dev/null 2&gt;&amp;1


echo &quot;[TASK 7] Install Cilium CNI&quot;
NODEIP=$(ip -4 addr show eth1 | grep -oP &#x27;(?&lt;=inet\s)\d+(\.\d+){3}&#x27;)
helm repo add cilium https://helm.cilium.io/ &gt;/dev/null 2&gt;&amp;1
helm repo update &gt;/dev/null 2&gt;&amp;1
helm install cilium cilium/cilium --version $2 --namespace kube-system \
--set k8sServiceHost=192.168.10.100 --set k8sServicePort=6443 \
--set ipam.mode=&quot;cluster-pool&quot; --set ipam.operator.clusterPoolIPv4PodCIDRList={&quot;172.20.0.0/16&quot;} --set ipv4NativeRoutingCIDR=172.20.0.0/16 \
--set routingMode=native --set autoDirectNodeRoutes=true --set endpointRoutes.enabled=true \
--set kubeProxyReplacement=true --set bpf.masquerade=true --set installNoConntrackIptablesRules=true \
--set endpointHealthChecking.enabled=false --set healthChecking=false \
--set hubble.enabled=false --set operator.replicas=1 --set debug.enabled=true &gt;/dev/null 2&gt;&amp;1


echo &quot;[TASK 8] Install Cilium CLI&quot;
CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
CLI_ARCH=amd64
if [ &quot;$(uname -m)&quot; = &quot;aarch64&quot; ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz &gt;/dev/null 2&gt;&amp;1
tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-linux-${CLI_ARCH}.tar.gz


echo &quot;[TASK 9] local DNS with hosts file&quot;
echo &quot;192.168.10.100 k8s-ctr&quot; &gt;&gt; /etc/hosts
for (( i=1; i&lt;=$1; i++  )); do echo &quot;192.168.10.10$i k8s-w$i&quot; &gt;&gt; /etc/hosts; done


echo &quot;&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;&quot;</code></pre><ul id="23bb8b2c-1c23-8036-8589-fef7e0deb9e5" class="bulleted-list"><li style="list-style-type:disc"><code>--set endpointHealthChecking.enabled=false</code> and -<code>-set healthChecking=false</code> disable endpoint health checking entirely. </li></ul><ul id="23bb8b2c-1c23-80ab-b79c-e4e1be1a8104" class="bulleted-list"><li style="list-style-type:disc"><strong>However it is recommended that those features be enabled initially on a smaller cluster (3-10 nodes) where it can be used to detect potential packet loss due to firewall rules or hypervisor settings. - </strong><strong><a href="https://docs.cilium.io/en/stable/operations/performance/scalability/report/">Docs</a></strong></li></ul><p id="23bb8b2c-1c23-8003-a69c-cdd2895a462e" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-80f3-8433-c520133c1188" class="toggle"><li><details open=""><summary>k8s-w.sh : kubeadm join</summary><ul id="23bb8b2c-1c23-8000-8fea-d9d1d7efc4f4" class="toggle"><li><details open=""><summary>kubeadm-join-worker-config.yaml</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-808d-9589-c5fcb15edea2" class="code"><code class="language-Bash">apiVersion: kubeadm.k8s.io/v1beta4
kind: JoinConfiguration
discovery:
  bootstrapToken:
    token: &quot;123456.1234567890123456&quot;
    apiServerEndpoint: &quot;192.168.10.100:6443&quot;
    unsafeSkipCAVerification: true
nodeRegistration:
  criSocket: &quot;unix:///run/containerd/containerd.sock&quot;
  kubeletExtraArgs:
    - name: node-ip
      value: &quot;NODE_IP_PLACEHOLDER&quot;</code></pre><p id="23bb8b2c-1c23-8043-af97-f892d16d6b70" class="">
</p></details></li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-807a-97e7-db7b5d2775dc" class="code"><code class="language-Bash">#!/usr/bin/env bash

echo &quot;&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;&quot;


echo &quot;[TASK 1] K8S Controlplane Join&quot;
curl --silent -o /root/kubeadm-join-worker-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-join-worker-config.yaml
NODEIP=$(ip -4 addr show eth1 | grep -oP &#x27;(?&lt;=inet\s)\d+(\.\d+){3}&#x27;)
sed -i &quot;s/NODE_IP_PLACEHOLDER/${NODEIP}/g&quot; /root/kubeadm-join-worker-config.yaml
kubeadm join --config=&quot;/root/kubeadm-join-worker-config.yaml&quot; &gt; /dev/null 2&gt;&amp;1


echo &quot;&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;&quot;
</code></pre><p id="23bb8b2c-1c23-80d1-88bc-ff3f76d4c9e6" class="">
</p></details></li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80d5-adc9-c002b8bbc871" class="code"><code class="language-Bash">mkdir cilium-lab &amp;&amp; cd cilium-lab

curl -O https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/Vagrantfile

vagrant up</code></pre><p id="23bb8b2c-1c23-801b-8fdf-e694b1553826" class="">
</p></li></ul><ul id="23bb8b2c-1c23-805d-b9b3-f9efd8fbdfb8" class="toggle"><li><details open=""><summary><strong>실습 환경 배포</strong> : <code><strong>vagrant up</strong></code></summary><ul id="23bb8b2c-1c23-8041-a487-c9e383d255bf" class="bulleted-list"><li style="list-style-type:disc">[k8s-ctr] 접속 후 기본 정보 확인<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-804f-9d76-c92d4a875abc" class="code"><code class="language-Bash"># ssh 접속 전, 노드들의 eth0 IP 확인
for i in ctr w1 w2 ; do echo &quot;&gt;&gt; node : k8s-$i &lt;&lt;&quot;; vagrant ssh k8s-$i -c &#x27;ip -c -4 addr show dev eth0&#x27;; echo; done #

# k8s-ctr 접속

cat /etc/hosts
sshpass -p &#x27;vagrant&#x27; ssh -o StrictHostKeyChecking=no vagrant@k8s-w1 hostname
sshpass -p &#x27;vagrant&#x27; ssh -o StrictHostKeyChecking=no vagrant@k8s-w2 hostname

#
ifconfig | grep -iEA1 &#x27;eth[0-9]:&#x27;

# 클러스터 정보 확인
kubectl cluster-info
kubectl cluster-info dump | grep -m 2 -E &quot;cluster-cidr|service-cluster-ip-range&quot;
kubectl describe cm -n kube-system kubeadm-config
kubectl describe cm -n kube-system kubelet-config

# 노드 정보 : 상태, INTERNAL-IP 확인
kubectl get node -owide

# 노드별 kubeadm-flags.env 정보 확인
cat /var/lib/kubelet/kubeadm-flags.env
for i in w1 w2 ; do echo &quot;&gt;&gt; node : k8s-$i &lt;&lt;&quot;; sshpass -p &#x27;vagrant&#x27; ssh vagrant@k8s-$i cat /var/lib/kubelet/kubeadm-flags.env ; echo; done

# 파드 정보 : 상태, 파드 IP 확인
kubectl get nodes -o jsonpath=&#x27;{range .items[*]}{.metadata.name}{&quot;\t&quot;}{.spec.podCIDR}{&quot;\n&quot;}{end}&#x27;
kubectl get ciliumnode -o json | grep podCIDRs -A2
kubectl get pod -A -owide

# iptables 확인
iptables-save
iptables -t nat -S
iptables -t filter -S
iptables -t mangle -S</code></pre><p id="23bb8b2c-1c23-8054-a79b-d2161564b161" class="">
</p></li></ul><ul id="23bb8b2c-1c23-80bc-9398-d7372d878623" class="bulleted-list"><li style="list-style-type:disc">[k8s-ctr] cilium 설치 정보 확인<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-805f-90b2-e4f8aac49d7d" class="code"><code class="language-Bash"># cilium 상태 확인
which cilium
cilium status
cilium config view
kubectl get cm -n kube-system cilium-config -o json | jq

#
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg config
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg status --verbose
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg metrics list

# 등록된 endpoint list들
kubectl exec -it -n kube-system ds/cilium -c cilium-agent -- cilium-dbg endpoint list

#
kubectl get ciliumendpoints -A

# monitor
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor -v
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor -v -v

## Filter for only the events related to endpoint
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor --related-to=&lt;id&gt;

## Show notifications only for dropped packet events
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor --type drop

## Don’t dissect packet payload, display payload in hex information
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor -v -v --hex

## Layer7
kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg monitor -v --type l7</code></pre></li></ul><p id="23bb8b2c-1c23-804f-b0a8-e6f43a0c75a5" class="">
</p></details></li></ul></li></ol><ol type="1" id="23bb8b2c-1c23-8012-a60b-d169de42199a" class="numbered-list" start="1"><li><strong>Network Observability with Hubble</strong><ul id="23bb8b2c-1c23-8089-9400-f50150bcd6d9" class="toggle"><li><details open=""><summary><strong>1.1. Hubble 소개</strong> - <a href="https://docs.cilium.io/en/stable/overview/intro/#intro">Docs</a> , <a href="https://docs.cilium.io/en/stable/observability/hubble/">https://docs.cilium.io/en/stable/observability/hubble/</a></summary><ul id="23bb8b2c-1c23-80c7-ac78-eb748dacfb29" class="bulleted-list"><li style="list-style-type:disc"><strong>공식 문서 한글 정리</strong> by 박용철님 - <a href="https://gitlab.com/ycheol76/cilium-study/-/blob/main/1st-week/01.%20Cilium%20&amp;%20Hubble%20%EC%86%8C%EA%B0%9C.md?ref_type=heads">소개</a>* , <a href="https://gitlab.com/ycheol76/cilium-study/-/blob/main/1st-week/02.%20%EA%B5%AC%EC%84%B1%EC%9A%94%EC%86%8C.md?ref_type=heads">구성요소</a>*</li></ul><ul id="23bb8b2c-1c23-8039-9141-f264c2abf29c" class="bulleted-list"><li style="list-style-type:disc">Hubble은 완전히 분산된 네트워킹 및 보안 관측 가능성 플랫폼입니다. 이 플랫폼은 Cilium 과 eBPF를 기반으로 구축되어 서비스의 통신 및 동작뿐만 아니라 네트워킹 인프라에 대한 깊은 가시성을 완전히 투명하게 제공합니다.</li></ul><ul id="23bb8b2c-1c23-806f-b845-e59e278c4f43" class="bulleted-list"><li style="list-style-type:disc">Hubble은 Cilium을 기반으로 eBPF를 활용하여 가시성을 확보할 수 있습니다. eBPF에 의존하면 모든 가시성을 프로그래밍할 수 있으며, 사용자가 필요로 하는 깊고 세밀한 가시성을 제공하면서 오버헤드를 최소화하는 동적 접근 방식을 제공할 수 있습니다. Hubble은 이러한 새로운 eBPF 기능을 최대한 활용하도록 설계되었습니다.</li></ul><ul id="23bb8b2c-1c23-80da-8331-dc59d96032cb" class="bulleted-list"><li style="list-style-type:disc">Observability은 Hubble에 의해 제공되며, 이를 통해 서비스의 통신 및 행동뿐만 아니라 네트워킹 인프라에 대한 깊은 가시성을 완전히 투명하게 파악할 수 있습니다. Hubble은 다중 클러스터(클러스터 메시) 시나리오에서 노드 수준, 클러스터 수준 또는 클러스터 간 가시성을 제공할 수 있습니다.</li></ul><ul id="23bb8b2c-1c23-8084-a3ff-c9081eb0540d" class="bulleted-list"><li style="list-style-type:disc">기본적으로 <strong><span style="border-bottom:0.05em solid">Hubble API</span></strong>는 <strong>Cilium 에이전트가 실행되는 개별 노드의 범위 내</strong>에서 <strong>작동</strong>합니다. 이는 로컬 Cilium 에이전트가 관찰한 트래픽에 대한 네트워크 인사이트를 제한합니다. Hubble CLI는 <strong>로컬 유닉스 도메인 소켓</strong>을 통해 제공되는 Hubble API를 쿼리하는 데 사용할 수 있습니다. Hubble CLI 바이너리는 기본적으로 <strong>Cilium 에이전트 포드</strong>에 설치됩니다.</li></ul><ul id="23bb8b2c-1c23-8032-b702-f2b61f13a0c3" class="bulleted-list"><li style="list-style-type:disc"><strong><span style="border-bottom:0.05em solid">Hubble Relay</span></strong>를 배포하면 클러스터 메시 시나리오에서 전체 클러스터 또는 <strong>여러 클러스터에 대한 네트워크 가시성</strong>이 제공됩니다. 이 모드에서는 Hubble CLI를 Hubble Relay 서비스로 안내하거나 <strong><span style="border-bottom:0.05em solid">Hubble UI</span></strong>를 통해 Hubble 데이터에 액세스할 수 있습니다. Hubble UI는 웹 인터페이스로, L3/L4 및 심지어 L7 계층에서 서비스 종속성 그래프를 자동으로 검색할 수 있게 하여 사용자 친화적인 시각화 및 서비스 맵으로서의 데이터 흐름 필터링을 가능하게 합니다.</li></ul><ul id="23bb8b2c-1c23-80a3-a2fd-fbd32823a49a" class="bulleted-list"><li style="list-style-type:disc"><strong>Service dependencies &amp; communication map</strong><ul id="23bb8b2c-1c23-80d8-b8b9-dda7ca277ca2" class="bulleted-list"><li style="list-style-type:circle">What services are communicating with each other? How frequently? What does the service dependency graph look like?</li></ul><ul id="23bb8b2c-1c23-8002-986e-d8824dd7f8dd" class="bulleted-list"><li style="list-style-type:circle">What HTTP calls are being made? What Kafka topics does a service consume from or produce to?</li></ul></li></ul><ul id="23bb8b2c-1c23-800e-9db1-f878ef06a177" class="bulleted-list"><li style="list-style-type:disc"><strong>Network monitoring &amp; alerting</strong><ul id="23bb8b2c-1c23-80c3-928d-cb082397e0aa" class="bulleted-list"><li style="list-style-type:circle">Is any network communication failing? Why is communication failing? Is it DNS? Is it an application or network problem? Is the communication broken on layer 4 (TCP) or layer 7 (HTTP)?</li></ul><ul id="23bb8b2c-1c23-80cb-b780-f6bbf2db34f7" class="bulleted-list"><li style="list-style-type:circle">Which services have experienced a DNS resolution problem in the last 5 minutes? Which services have experienced an interrupted TCP connection recently or have seen connections timing out? What is the rate of unanswered TCP SYN requests?</li></ul></li></ul><ul id="23bb8b2c-1c23-8057-9a8a-f72902bbc45a" class="bulleted-list"><li style="list-style-type:disc"><strong>Application monitoring</strong><ul id="23bb8b2c-1c23-80f3-bd8e-ecf5bb07ca34" class="bulleted-list"><li style="list-style-type:circle">What is the rate of 5xx or 4xx HTTP response codes for a particular service or across all clusters?</li></ul><ul id="23bb8b2c-1c23-80c4-b02b-c19c10e70d36" class="bulleted-list"><li style="list-style-type:circle">What is the 95th and 99th percentile latency between HTTP requests and responses in my cluster? Which services are performing the worst? What is the latency between two services?</li></ul></li></ul><ul id="23bb8b2c-1c23-802b-902d-d2d4928b302d" class="bulleted-list"><li style="list-style-type:disc"><strong>Security observability</strong><ul id="23bb8b2c-1c23-8033-a47e-db200e514866" class="bulleted-list"><li style="list-style-type:circle">Which services had connections blocked due to network policy? What services have been accessed from outside the cluster? Which services have resolved a particular DNS name?</li></ul></li></ul><p id="23bb8b2c-1c23-80ff-a433-edff225ca843" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-806e-a685-c3a605be815c" class="toggle"><li><details open=""><summary><mark class="highlight-blue"><strong>1.2. Setting up Hubble Observability</strong></mark> - <a href="https://docs.cilium.io/en/stable/observability/hubble/setup/">Docs</a></summary><ul id="23bb8b2c-1c23-800d-bd95-df82a8bdccb7" class="bulleted-list"><li style="list-style-type:disc">설치 전 확인<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8021-bb95-c1bfa1313f20" class="code"><code class="language-Bash">#
cilium status
cilium config view | grep -i hubble
kubectl get cm -n kube-system cilium-config -o json | jq

# hubble 관련 resouce가 현재 없음
kubectl get secret -n kube-system | grep -iE &#x27;cilium-ca|hubble&#x27;
ss -tnlp | grep -iE &#x27;cilium|hubble&#x27; | tee before.txt
LISTEN 0      4096        127.0.0.1:39465      0.0.0.0:*    users:((&quot;cilium-agent&quot;,pid=5402,fd=42))               
LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:*    users:((&quot;cilium-agent&quot;,pid=5402,fd=6))                
LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:*    users:((&quot;cilium-operator&quot;,pid=5522,fd=6))             
LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=27))               
LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=26))               
LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:*    users:((&quot;cilium-agent&quot;,pid=5402,fd=53))               
LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:*    users:((&quot;cilium-operator&quot;,pid=5522,fd=9))             
LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=25))               
LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=24))               
LISTEN 0      4096                *:9963             *:*    users:((&quot;cilium-operator&quot;,pid=5522,fd=7)) 
</code></pre><p id="23bb8b2c-1c23-8083-8832-e870045419c4" class="">
</p></li></ul><ul id="23bb8b2c-1c23-807e-883b-d01b142595f6" class="bulleted-list"><li style="list-style-type:disc">Hubble 설치<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8034-9a65-c753e7a85f4c" class="code"><code class="language-Bash"># 설치방안 1 : hubble 활성화, 메트릭 설정 등등
helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values \
--set hubble.enabled=true \
--set hubble.relay.enabled=true \
--set hubble.ui.enabled=true \
--set hubble.ui.service.type=NodePort \
--set hubble.ui.service.nodePort=31234 \
--set hubble.export.static.enabled=true \
--set hubble.export.static.filePath=/var/run/cilium/hubble/events.log \
--set prometheus.enabled=true \
--set operator.prometheus.enabled=true \
--set hubble.metrics.enableOpenMetrics=true \
--set hubble.metrics.enabled=&quot;{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\,source_namespace\,source_workload\,destination_ip\,destination_namespace\,destination_workload\,traffic_direction}&quot;

# 설치방안 2 : hubble 활성화
cilium hubble enable
cilium hubble enable --ui


# This is required for Relay to operate correctly.
cilium status
Hubble Relay:       OK

#
cilium config view | grep -i hubble
kubectl get cm -n kube-system cilium-config -o json | grep -i hubble

#
kubectl get secret -n kube-system | grep -iE &#x27;cilium-ca|hubble&#x27;

# # Enabling Hubble requires the TCP port 4244 to be open on all nodes running Cilium.
ss -tnlp | grep -iE &#x27;cilium|hubble&#x27; | tee after.txt

vi -d before.txt after.txt
LISTEN 0      4096        127.0.0.1:39465      0.0.0.0:*    users:((&quot;cilium-agent&quot;,pid=5402,fd=|  LISTEN 0      4096        127.0.0.1:39465      0.0.0.0:*    users:((&quot;cilium-agent&quot;,pid=14271,fd
LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:*    users:((&quot;cilium-agent&quot;,pid=5402,fd=|  LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:*    users:((&quot;cilium-agent&quot;,pid=14271,fd
LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:*    users:((&quot;cilium-operator&quot;,pid=5522,|  LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:*    users:((&quot;cilium-operator&quot;,pid=5522,
LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=|  LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=
LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=|  LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=
LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:*    users:((&quot;cilium-agent&quot;,pid=5402,fd=|  LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:*    users:((&quot;cilium-agent&quot;,pid=14271,fd
LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:*    users:((&quot;cilium-operator&quot;,pid=5522,|  LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:*    users:((&quot;cilium-operator&quot;,pid=5522,
LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=|  LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=
LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=|  LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:((&quot;cilium-envoy&quot;,pid=5494,fd=
-----------------------------------------------------------------------------------------------|  LISTEN 0      4096                *:4244             *:*    users:((&quot;cilium-agent&quot;,pid=14271,fd
-----------------------------------------------------------------------------------------------|  LISTEN 0      4096                *:9965             *:*    users:((&quot;cilium-agent&quot;,pid=14271,fd
-----------------------------------------------------------------------------------------------|  LISTEN 0      4096                *:9962             *:*    users:((&quot;cilium-agent&quot;,pid=14271,fd
LISTEN 0      4096                *:9963             *:*    users:((&quot;cilium-operator&quot;,pid=5522,|  LISTEN 0      4096                *:9963             *:*    users:((&quot;cilium-operator&quot;,pid=5522,

for i in w1 w2 ; do echo &quot;&gt;&gt; node : k8s-$i &lt;&lt;&quot;; sshpass -p &#x27;vagrant&#x27; ssh vagrant@k8s-$i sudo ss -tnlp |grep 4244 ; echo; done

#
kubectl get pod -n kube-system -l k8s-app=hubble-relay
kc describe pod -n kube-system -l k8s-app=hubble-relay

kc get svc,ep -n kube-system hubble-relay
...
NAME                     ENDPOINTS           AGE
endpoints/hubble-relay   172.20.1.202:4245   7m54s


# hubble-relay 는 hubble-peer 의 서비스(ClusterIP :443)을 통해 모든 노드의 :4244에 요청 가져올 수 있음
# hubble-relay pod --&gt; hubble-peer svc -&gt; 각 node:4244(=hubble peer)의 flow로 network monitoring 정보를 가져옴
kubectl get cm -n kube-system
kubectl describe cm -n kube-system hubble-relay-config
...
cluster-name: default
peer-service: &quot;hubble-peer.kube-system.svc.cluster.local.:443&quot;
listen-address: :4245
...

#
kubectl get svc,ep -n kube-system hubble-peer
NAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
service/hubble-peer   ClusterIP   10.96.130.103   &lt;none&gt;        443/TCP   8m43s

NAME                    ENDPOINTS                                                     AGE
endpoints/hubble-peer   192.168.10.100:4244,192.168.10.101:4244,192.168.10.102:4244   8m43s

#
kc describe pod -n kube-system -l k8s-app=hubble-ui
...
Containers:
  frontend:
  ...
  backend:
...

kc describe cm -n kube-system hubble-ui-nginx
...

#
kubectl get svc,ep -n kube-system hubble-ui
NAME                TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/hubble-ui   NodePort   10.96.234.220   &lt;none&gt;        80:31234/TCP   11m

NAME                  ENDPOINTS           AGE
endpoints/hubble-ui   172.20.2.133:8081   11m

# hubble ui 웹 접속 주소 확인
NODEIP=$(ip -4 addr show eth1 | grep -oP &#x27;(?&lt;=inet\s)\d+(\.\d+){3}&#x27;)
echo -e &quot;http://$NODEIP:31234&quot;
</code></pre><figure id="23bb8b2c-1c23-8018-a104-c2c3ca78ddc1" class="image"><a href="images/image.png"><img src="images/image.png"/></a></figure><ul id="23bb8b2c-1c23-80cf-a49c-fdf80b6792e7" class="bulleted-list"><li style="list-style-type:circle">hubble ui 웹 접속 후 → kube-system 네임스페이스 선택<figure id="23bb8b2c-1c23-80c6-ae2a-c8d6aa552cc2" class="image"><a href="images/CleanShot_2025-07-20_at_07.11.57.png"><img style="width:816px" src="images/CleanShot_2025-07-20_at_07.11.57.png"/></a></figure></li></ul><p id="23bb8b2c-1c23-8034-9a98-deb33110cb72" class="">
</p></li></ul><ul id="23bb8b2c-1c23-8035-9068-d89b7369a0a1" class="bulleted-list"><li style="list-style-type:disc">Hubble Client 설치 - <a href="https://docs.cilium.io/en/stable/observability/hubble/setup/#install-the-hubble-client">Docs</a><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8002-9438-c273c1bbb8a0" class="code"><code class="language-Bash"># Linux 실습 환경에 설치 시
HUBBLE_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/hubble/master/stable.txt)
HUBBLE_ARCH=amd64
if [ &quot;$(uname -m)&quot; = &quot;aarch64&quot; ]; then HUBBLE_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/hubble/releases/download/$HUBBLE_VERSION/hubble-linux-${HUBBLE_ARCH}.tar.gz{,.sha256sum}
sudo tar xzvfC hubble-linux-${HUBBLE_ARCH}.tar.gz /usr/local/bin
which hubble

# 아직 node의 4245 port가 열려있지 않음 아래에서 port-foward를 통해 4245 port open
hubble status
failed getting status: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing: dial tcp 127.0.0.1:4245: connect: connection refused&quot;</code></pre><p id="23bb8b2c-1c23-8062-9b7b-f573c4a7765c" class="">
</p></li></ul><ul id="23bb8b2c-1c23-80f4-9ddc-ed76cb3bd3c7" class="bulleted-list"><li style="list-style-type:disc"><strong>Validate Hubble API Access</strong><ul id="23bb8b2c-1c23-806a-b517-d783274b816e" class="bulleted-list"><li style="list-style-type:circle">In order to <strong>access</strong> the <strong>Hubble API</strong>, create a port forward to the Hubble service from <strong>your local machine.</strong> </li></ul><ul id="23bb8b2c-1c23-80cf-a329-e5b29e3858d6" class="bulleted-list"><li style="list-style-type:circle">This will allow you to connect the <strong>Hubble client</strong> to the local port <code>4245</code> and access the <mark class="highlight-red"><strong>Hubble Relay service</strong></mark> in your Kubernetes cluster. </li></ul><ul id="23bb8b2c-1c23-80b2-a074-e17c211133bb" class="bulleted-list"><li style="list-style-type:circle">For more information on this method, see <a href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/">Use Port Forwarding to Access Application in a Cluster</a>.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80a6-97a4-c9a33f2cee6d" class="code"><code class="language-Bash">#
cilium hubble port-forward&amp;
Hubble Relay is available at 127.0.0.1:4245

ss -tnlp | grep 4245

# Now you can validate that you can access the Hubble API via the installed CLI
hubble status
Healthcheck (via localhost:4245): Ok
Current/Max Flows: 12,285/12,285 (100.00%)
Flows/s: 41.20

# hubble (api) server 기본 접속 주소 확인
hubble config view 
...
port-forward-port: &quot;4245&quot;
server: localhost:4245
...

# (옵션) 현재 k8s-ctr 가상머신이 아닌, 자신의 PC에 kubeconfig 설정 후 아래 --server 옵션을 통해 hubble api server 사용해보자!
hubble help status | grep &#x27;server string&#x27;
      --server string                 Address of a Hubble server. Ignored when --input-file or --port-forward is provided. (default &quot;localhost:4245&quot;)

# You can also query the flow API and look for flows
kubectl get ciliumendpoints.cilium.io -n kube-system # SECURITY IDENTITY
hubble observe
hubble observe -h
hubble observe -f
</code></pre></li></ul><p id="23bb8b2c-1c23-800a-b58d-e4dc43bd1023" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-80b6-84db-f31d4735f4e1" class="toggle"><li><details open=""><summary><strong>1.3. Cilium Agent 단축키 지정</strong> &amp; Cilium CMD Cheatsheet - <a href="https://docs.cilium.io/en/stable/cheatsheet/">Docs</a> , CMD Reference - <a href="https://docs.cilium.io/en/stable/cmdref/">Docs</a></summary><figure id="23bb8b2c-1c23-801f-ab9b-dabfe45dd89f"><div class="source"><a href="images/Isovalent_-_Cilium_Cheat_Sheet.pdf">Isovalent - Cilium Cheat Sheet.pdf</a></div></figure><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80e4-81f6-f56fc60db73c" class="code"><code class="language-Bash"># cilium 파드 이름
export CILIUMPOD0=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-ctr -o jsonpath=&#x27;{.items[0].metadata.name}&#x27;)
export CILIUMPOD1=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-w1  -o jsonpath=&#x27;{.items[0].metadata.name}&#x27;)
export CILIUMPOD2=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-w2  -o jsonpath=&#x27;{.items[0].metadata.name}&#x27;)
echo $CILIUMPOD0 $CILIUMPOD1 $CILIUMPOD2

# 단축키(alias) 지정
alias c0=&quot;kubectl exec -it $CILIUMPOD0 -n kube-system -c cilium-agent -- cilium&quot;
alias c1=&quot;kubectl exec -it $CILIUMPOD1 -n kube-system -c cilium-agent -- cilium&quot;
alias c2=&quot;kubectl exec -it $CILIUMPOD2 -n kube-system -c cilium-agent -- cilium&quot;

alias c0bpf=&quot;kubectl exec -it $CILIUMPOD0 -n kube-system -c cilium-agent -- bpftool&quot;
alias c1bpf=&quot;kubectl exec -it $CILIUMPOD1 -n kube-system -c cilium-agent -- bpftool&quot;
alias c2bpf=&quot;kubectl exec -it $CILIUMPOD2 -n kube-system -c cilium-agent -- bpftool&quot;


# endpoint
c0 endpoint list
c0 endpoint list -o json
c1 endpoint list
c2 endpoint list

c1 endpoint get &lt;id&gt;
c1 endpoint log &lt;id&gt;

## Enable debugging output on the cilium-dbg monitor for this endpoint
c1 endpoint config &lt;id&gt; Debug=true


# monitor
c1 monitor
c1 monitor -v
c1 monitor -v -v

## Filter for only the events related to endpoint
c1 monitor --related-to=&lt;id&gt;

## Show notifications only for dropped packet events
c1 monitor --type drop

## Don’t dissect packet payload, display payload in hex information
c1 monitor -v -v --hex

## Layer7
c1 monitor -v --type l7


# Manage IP addresses and associated information - IP List
c0 ip list

# IDENTITY :  1(host), 2(world), 4(health), 6(remote), 파드마다 개별 ID
c0 ip list -n

# Retrieve information about an identity
c0 identity list

# 엔드포인트 기준 ID
c0 identity list --endpoints

# 엔드포인트 설정 확인 및 변경
c0 endpoint config &lt;엔트포인트ID&gt;

# 엔드포인트 상세 정보 확인
c0 endpoint get &lt;엔트포인트ID&gt;

# 엔드포인트 로그 확인
c0 endpoint log &lt;엔트포인트ID&gt;

# Show bpf filesystem mount details
c0 bpf fs show

# bfp 마운트 폴더 확인
tree /sys/fs/bpf


# Get list of loadbalancer services
c0 service list
c1 service list
c2 service list

## Or you can get the loadbalancer information using bpf list
c0 bpf lb list
c1 bpf lb list
c2 bpf lb list

## List reverse NAT entries
c1 bpf lb list --revnat
c2 bpf lb list --revnat


# List connection tracking entries
c0 bpf ct list global
c1 bpf ct list global
c2 bpf ct list global

# Flush connection tracking entries
c0 bpf ct flush
c1 bpf ct flush
c2 bpf ct flush


# List all NAT mapping entries
c0 bpf nat list
c1 bpf nat list
c2 bpf nat list

# Flush all NAT mapping entries
c0 bpf nat flush
c1 bpf nat flush
c2 bpf nat flush

# Manage the IPCache mappings for IP/CIDR &lt;-&gt; Identity
c0 bpf ipcache list# Display cgroup metadata maintained by Cilium
c0 cgroups list
c1 cgroups list
c2 cgroups list


# List all open BPF maps
c0 map list
c1 map list --verbose
c2 map list --verbose

c1 map events cilium_lb4_services_v2
c1 map events cilium_lb4_reverse_nat
c1 map events cilium_lxc
c1 map events cilium_ipcache


# List all metrics
c1 metrics list


# List contents of a policy BPF map : Dump all policy maps
c0 bpf policy get --all
c1 bpf policy get --all -n
c2 bpf policy get --all -n


# Dump StateDB contents as JSON
c0 statedb dump


#
c0 shell -- db/show devices
c1 shell -- db/show devices
c2 shell -- db/show devices
</code></pre><p id="23bb8b2c-1c23-808e-af90-e68c5592e96c" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-80b3-99ff-c3ab05a013e0" class="toggle"><li><details open=""><summary>1.4. Getting Started with the Star Wars Demo<strong> &amp; Hubble/UI</strong> - <a href="https://docs.cilium.io/en/stable/gettingstarted/demo/">Docs</a></summary><ul id="23bb8b2c-1c23-8089-946e-cab0513058ed" class="bulleted-list"><li style="list-style-type:disc"><strong>Deploy the Demo Application</strong><figure id="23bb8b2c-1c23-803c-b2b3-e35ae0c6c9ff" class="image"><a href="images/image%201.png"><img style="width:720px" src="images/image%201.png"/></a></figure><ul id="23bb8b2c-1c23-8012-aa39-da5469e2706e" class="bulleted-list"><li style="list-style-type:circle">스타워즈에서 영감을 받은 예제에서는 데스스타, 타이파이터, 엑스윙의 세 가지 마이크로서비스 애플리케이션이 있습니다. </li></ul><ul id="23bb8b2c-1c23-807a-9974-f4c5cbe5d798" class="bulleted-list"><li style="list-style-type:circle">데스스타는 포트 80에서 HTTP 웹서비스를 실행하며, 이 서비스는 두 개의 포드 복제본에 걸쳐 데스스타에 대한 요청을 로드 밸런싱하는 Kubernetes 서비스로 노출됩니다. </li></ul><ul id="23bb8b2c-1c23-80e9-a3c4-ce7c3c5d3eec" class="bulleted-list"><li style="list-style-type:circle">데스스타 서비스는 제국의 우주선에 착륙 서비스를 제공하여 착륙 포트를 요청할 수 있도록 합니다. </li></ul><ul id="23bb8b2c-1c23-808d-905f-c6e8e878c062" class="bulleted-list"><li style="list-style-type:circle">타이파이터 포드는 일반적인 제국 선박의 착륙 요청 클라이언트 서비스를 나타내며, 엑스윙은 동맹 선박의 유사한 서비스를 나타냅니다. </li></ul><ul id="23bb8b2c-1c23-805c-8374-c477ca6c36b6" class="bulleted-list"><li style="list-style-type:circle">데스스타 착륙 서비스에 대한 접근 제어를 위한 다양한 보안 정책을 테스트할 수 있도록 존재합니다.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8040-bc14-f7c884c44253" class="code"><code class="language-Bash">#
kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/http-sw-app.yaml
service/deathstar created
deployment.apps/deathstar created
pod/tiefighter created
pod/xwing created

# 파드 라벨 labels 확인
kubectl get pod --show-labels
NAME                        READY   STATUS    RESTARTS   AGE   LABELS
deathstar-8c4c77fb7-jzqhp   1/1     Running   0          61s   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=8c4c77fb7
deathstar-8c4c77fb7-w8d6w   1/1     Running   0          61s   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=8c4c77fb7
tiefighter                  1/1     Running   0          61s   app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire
xwing                       1/1     Running   0          61s   app.kubernetes.io/name=xwing,class=xwing,org=alliance

kubectl get deploy,svc,ep deathstar
NAME                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/deathstar   2/2     2            2           93s

NAME                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
service/deathstar   ClusterIP   10.96.235.114   &lt;none&gt;        80/TCP    93s

NAME                  ENDPOINTS                        AGE
endpoints/deathstar   172.20.1.116:80,172.20.2.26:80   93s

#
kubectl get ciliumendpoints.cilium.io -A
kubectl get ciliumidentities.cilium.io

# in a multi-node installation, only the ones running on the same node will be listed
kubectl exec -it -n kube-system ds/cilium -c cilium-agent -- cilium endpoint list
c0 endpoint list
c1 endpoint list
c2 endpoint list # 현재 ingress/egress 에 정책(Policy) 없음! , Labels 정보 확인
ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])
...
1905       Disabled           Disabled          1021       k8s:app.kubernetes.io/name=deathstar                                                172.20.2.26    ready   
                                                           k8s:class=deathstar                                                                                        
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=empire   </code></pre><p id="23bb8b2c-1c23-8009-8694-ea0f24946132" class="">
</p></li></ul><ul id="23bb8b2c-1c23-80fe-be79-f8f0958cf53e" class="bulleted-list"><li style="list-style-type:disc"><strong>Check Current Access</strong><ul id="23bb8b2c-1c23-80a6-80cf-d669fa5bf6bb" class="bulleted-list"><li style="list-style-type:circle">데스스타 서비스의 관점에서 보면, org= empire 라벨이 부착된 선박만 연결하여 착륙을 요청할 수 있습니다. </li></ul><ul id="23bb8b2c-1c23-801b-9e49-c8a9f291d503" class="bulleted-list"><li style="list-style-type:circle">우리는 규칙을 시행하지 않기 때문에 Xwing과 타이파이터 모두 착륙을 요청할 수 있습니다. 이를 테스트하려면 아래 명령을 사용하세요.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8050-86b5-f4b4e218bcb2" class="code"><code class="language-Bash"># 아래 출력에서 xwing 와 tiefighter 의 IDENTITY 메모
c1 endpoint list | grep -iE &#x27;xwing|tiefighter|deathstar&#x27;
c2 endpoint list | grep -iE &#x27;xwing|tiefighter|deathstar&#x27;

1618       Disabled           Disabled          2802       k8s:app.kubernetes.io/name=tiefighter                                               172.20.1.18    ready   
                                                           k8s:class=tiefighter                                                                                       
3012       Disabled           Disabled          16791      k8s:app.kubernetes.io/name=deathstar                                                172.20.1.116   ready   
                                                           k8s:class=deathstar                                                                                        
642        Disabled           Disabled          12255      k8s:app.kubernetes.io/name=xwing                                                    172.20.2.54    ready   
                                                           k8s:class=xwing                                                                                            
1905       Disabled           Disabled          1021       k8s:app.kubernetes.io/name=deathstar                                                172.20.2.26    ready   
                                                           k8s:class=deathstar

XWINGID=12255
TIEFIGHTERID=2802
DEATHSTARID=16791

# 모니터링 준비 : 터미널 3개, 단축키 설정
## 각각 monitor 확인
c0 monitor -v -v
c1 monitor -v -v
c2 monitor -v -v

# 모니터링 준비 : 터미널 1개
hubble observe -f

XWINGID=12255
TIEFIGHTERID=2802
DEATHSTARID=16791

hubble observe -f --from-identity $XWINGID

# 호출 시도 1
kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
while true; do kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing ; sleep 5 ; done

# coredns에 dns query하는 upd packet만 찍힘
hubble observe -f --protocol udp --from-identity $XWINGID
Jul 25 16:56:22.060: default/xwing (ID:12255) &lt;&gt; 10.96.0.10:53 (world) pre-xlate-fwd TRACED (UDP)
Jul 25 16:56:22.060: default/xwing (ID:12255) &lt;&gt; kube-system/coredns-674b8bbfcf-pxmpk:53 (ID:18848) post-xlate-fwd TRANSLATED (UDP)
Jul 25 16:56:22.060: default/xwing:53424 (ID:12255) -&gt; kube-system/coredns-674b8bbfcf-pxmpk:53 (ID:18848) to-network FORWARDED (UDP)
Jul 25 16:56:22.062: default/xwing (ID:12255) &lt;&gt; 10.96.0.10:53 (world) pre-xlate-fwd TRACED (UDP)
Jul 25 16:56:22.062: default/xwing (ID:12255) &lt;&gt; kube-system/coredns-674b8bbfcf-h4xsm:53 (ID:18848) post-xlate-fwd TRANSLATED (UDP)
...

# 이후 pod ip를 통해 tcp 통신하는 부분 찍힘
hubble observe -f --protocol tcp --from-identity $XWINGID
Jul 25 16:57:14.342: default/xwing:57392 (ID:12255) -&gt; default/deathstar-8c4c77fb7-jzqhp:80 (ID:16791) to-endpoint FORWARDED (TCP Flags: SYN)
Jul 25 16:57:14.342: default/xwing:57392 (ID:12255) -&gt; default/deathstar-8c4c77fb7-jzqhp:80 (ID:16791) to-endpoint FORWARDED (TCP Flags: ACK)
Jul 25 16:57:14.343: default/xwing (ID:12255) &lt;&gt; 10.96.235.114:80 (world) pre-xlate-fwd TRACED (TCP)
Jul 25 16:57:14.343: default/xwing (ID:12255) &lt;&gt; default/deathstar-8c4c77fb7-jzqhp:80 (ID:16791) post-xlate-fwd TRANSLATED (TCP)
Jul 25 16:57:14.343: default/xwing:57392 (ID:12255) &lt;&gt; default/deathstar-8c4c77fb7-jzqhp (ID:16791) pre-xlate-rev TRACED (TCP)

hubble observe -f --protocol tcp --from-identity $DEATHSTARID

# 호출 시도 2
kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
while true; do kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing ; sleep 5 ; done

## 모니터링
hubble observe -f --protocol tcp --from-identity $TIEFIGHTERID
hubble observe -f --protocol tcp --from-identity $DEATHSTARID
</code></pre><figure id="23bb8b2c-1c23-809e-8164-c29eac7c8026" class="image"><a href="images/CleanShot_2025-07-20_at_08.22.18.png"><img style="width:864px" src="images/CleanShot_2025-07-20_at_08.22.18.png"/></a></figure><p id="23bb8b2c-1c23-801a-a565-db0d3befa342" class="">
</p></li></ul><ul id="23bb8b2c-1c23-80f0-aed6-e5bd631f8294" class="bulleted-list"><li style="list-style-type:disc">Apply an L3/L4 Policy - <a href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-an-l3-l4-policy">Docs</a><figure id="23bb8b2c-1c23-803e-a72f-eba8a3238934" class="image"><a href="images/image%202.png"><img style="width:816px" src="images/image%202.png"/></a></figure><ul id="23bb8b2c-1c23-80b3-8975-e822dc2948af" class="bulleted-list"><li style="list-style-type:circle">Cilium을 사용할 때 보안 정책을 정의할 때 엔드포인트 IP 주소는 중요하지 않습니다. 대신 <strong>포드에 할당된 레이블</strong>을 사용하여 <strong>보안 정책을 정의</strong>할 수 있습니다. 정책은 클러스터 내에서 실행 중이거나 실행 중인 위치에 관계없이 레이블을 기반으로 올바른 포드에 적용됩니다.</li></ul><ul id="23bb8b2c-1c23-80c1-9b54-dfbb23def53a" class="bulleted-list"><li style="list-style-type:circle"><strong>데스스타 착륙 요청</strong>을 라벨이 있는 선박(org=empire)으로만 <strong>제한</strong>하는 <strong>기본 정책</strong>부터 시작하겠습니다. 이렇게 하면 org=empire 라벨이 없는 선박은 데스스타 서비스와 연결조차 할 수 없습니다. 이 정책은 IP 프로토콜(네트워크 계층 3)과 TCP 프로토콜(네트워크 계층 4)에만 적용되는 간단한 정책이므로 흔히 <strong>L3/L4 네트워크 보안 정책</strong>이라고 합니다.</li></ul><ul id="23bb8b2c-1c23-80ec-8cc1-e1176aa39047" class="bulleted-list"><li style="list-style-type:circle">참고: 실리움은 <strong>상태별 연결 추적</strong>을 수행합니다. 이는 정책이 프론트엔드가 백엔드에 도달할 수 있도록 허용하면, 동일한 TCP/UDP 연결 내에서 백엔드 응답의 일부인 모든<strong> 필수 응답 패킷이 자동</strong>으로 프론트엔드에 도달하도록 <strong>허용</strong>한다는 것을 의미합니다. <em><strong>→ 리턴 패킷 자동 허용!</strong></em></li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80b5-b2c2-f47e509ee603" class="code"><code class="language-Bash"># CiliumNetworkPolicy
## CiliumNetworkPolicys는 &quot;endpointSelector&quot;를 사용하여 팟 레이블에서 정책이 적용되는 소스와 목적지를 식별합니다. 
## 아래 정책은 TCP 포트 80에서 레이블(org=empire)이 있는 모든 팟에서 -&gt; 레이블(org=empire, class=deathstar)이 있는 데스스타 팟으로 전송되는 트래픽을 화이트리스트로 작성합니다.
## 즉, 위의 예제에서 deathstar service로 향하는 traffic중 org=empire label을 달고있는 tiefighter만 허용한다는 뜻
apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;rule1&quot;
spec:
  description: &quot;L3-L4 policy to restrict deathstar access to empire ships only&quot;
  endpointSelector:
    matchLabels:
      org: empire
      class: deathstar
  ingress:
  - fromEndpoints:
    - matchLabels:
        org: empire
    toPorts:
    - ports:
      - port: &quot;80&quot;
        protocol: TCP

kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/sw_l3_l4_policy.yaml
kubectl get cnp
kubectl get cnp -o json | jq

# 모니터링
hubble observe -f --type drop
Jul 25 17:03:20.736: default/xwing:57668 (ID:12255) &lt;&gt; default/deathstar-8c4c77fb7-w8d6w:80 (ID:1021) Policy denied DROPPED (TCP Flags: SYN)
Jul 25 17:03:21.778: default/xwing:57668 (ID:12255) &lt;&gt; default/deathstar-8c4c77fb7-w8d6w:80 (ID:1021) Policy denied DROPPED (TCP Flags: SYN)

# 호출 시도 1 
kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing --connect-timeout 2
command terminated with exit code 28

# 모니터링 
hubble observe -f --protocol tcp --from-identity $DEATHSTARID
Ship landed

# 호출 시도 2
kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
Jul 25 17:04:02.352: default/tiefighter:58948 (ID:2802) &lt;- default/deathstar-8c4c77fb7-jzqhp:80 (ID:16791) to-endpoint FORWARDED (TCP Flags: SYN, ACK)
Jul 25 17:04:02.352: default/deathstar-8c4c77fb7-jzqhp:80 (ID:16791) &lt;&gt; default/tiefighter (ID:2802) pre-xlate-rev TRACED (TCP)
Jul 25 17:04:02.352: default/deathstar-8c4c77fb7-jzqhp:80 (ID:16791) &lt;&gt; default/tiefighter (ID:2802) pre-xlate-rev TRACED (TCP)
Jul 25 17:04:02.353: default/tiefighter:58948 (ID:2802) &lt;- default/deathstar-8c4c77fb7-jzqhp:80 (ID:16791) to-endpoint FORWARDED (TCP Flags: ACK, PSH)
Jul 25 17:04:02.355: default/tiefighter:58948 (ID:2802) &lt;- default/deathstar-8c4c77fb7-jzqhp:80 (ID:16791) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</code></pre><figure id="23bb8b2c-1c23-8021-a573-e04b34ac7760" class="image"><a href="images/CleanShot_2025-07-20_at_10.20.39.png"><img style="width:768px" src="images/CleanShot_2025-07-20_at_10.20.39.png"/></a></figure><p id="23bb8b2c-1c23-80c8-a375-eab3d66fda60" class="">
</p></li></ul><ul id="23bb8b2c-1c23-809e-b8c7-c3f2344d9307" class="bulleted-list"><li style="list-style-type:disc"><strong>Inspecting the Policy</strong><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8078-a3e5-feab6fd42167" class="code"><code class="language-Bash"># deathstar 에 ingress 에 policy 활성화 확인
c0 endpoint list
c1 endpoint list
c2 endpoint list

# deathstar endpoint에 아래처럼 ingress policy가 enable 되어있고, 어떤 label 기준으로 policy가 적용되어있는지 확인!!
ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value]) 
...
1905       Enabled            Disabled          1021       k8s:app.kubernetes.io/name=deathstar                                                172.20.2.26    ready   
                                                           k8s:class=deathstar                                                                                        
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=empire   
                                                           
#
kc describe cnp rule1
</code></pre><p id="23bb8b2c-1c23-801b-a303-dcc0bef661d8" class="">
</p></li></ul><ul id="23bb8b2c-1c23-8042-9214-cd702e9690bd" class="bulleted-list"><li style="list-style-type:disc">Life of a Packet : L7 동작 처리는<strong> cilium-envoy 데몬셋</strong>이 담당 - <a href="https://docs.cilium.io/en/stable/network/ebpf/lifeofapacket/">Docs</a><figure id="23bb8b2c-1c23-80f9-bdc6-f5eb0befb1d5" class="image"><a href="images/cilium_bpf_ingress.svg"><img style="width:965.984375px" src="images/cilium_bpf_ingress.svg"/></a></figure><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8084-8a8c-efc279d7014d" class="code"><code class="language-Bash">#
kubectl get ds -n kube-system
NAME           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
cilium         3         3         3       3            3           kubernetes.io/os=linux   3h38m
cilium-envoy   3         3         3       3            3           kubernetes.io/os=linux   3h38m

kubectl get pod -n kube-system -l k8s-app=cilium-envoy -owide
NAME                 READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES
cilium-envoy-f8h2w   1/1     Running   0          111m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;
cilium-envoy-nq9zg   1/1     Running   0          109m   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;
cilium-envoy-xfc6k   1/1     Running   0          108m   192.168.10.102   k8s-w2    &lt;none&gt;           &lt;none&gt;

#
kc describe ds -n kube-system cilium-envoy
...
    Mounts:
      /sys/fs/bpf from bpf-maps (rw)
      /var/run/cilium/envoy/ from envoy-config (ro)
      /var/run/cilium/envoy/artifacts from envoy-artifacts (ro)
      /var/run/cilium/envoy/sockets from envoy-sockets (rw
   ...
   envoy-config:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      cilium-envoy-config
    Optional:  false
...


kubectl exec -it -n kube-system ds/cilium -c cilium-agent -- ss -xnp | grep -i -envoy
u_str ESTAB 0      0                                                  /var/run/cilium/envoy/sockets/xds.sock 50893            * 51246 users:((&quot;cilium-agent&quot;,pid=1,fd=186))
u_str ESTAB 0      0                                                /var/run/cilium/envoy/sockets/admin.sock 28872            * 29728                                      
u_str ESTAB 0      0                                                /var/run/cilium/envoy/sockets/admin.sock 29724            * 28870  

kc describe cm -n kube-system cilium-envoy-config
...
Data
====
bootstrap-config.json:
----
{&quot;admin&quot;:{&quot;address&quot;:{&quot;pipe&quot;:{&quot;path&quot;:&quot;/var/run/cilium/envoy/sockets/admin.sock&quot;}}}...
...
</code></pre></li></ul><p id="23bb8b2c-1c23-8061-9642-df2be59eeded" class="">
</p><ul id="23bb8b2c-1c23-80ac-b807-d113c6dc47f5" class="bulleted-list"><li style="list-style-type:disc"><strong>Apply and Test HTTP-aware L7 Policy</strong> - <a href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-and-test-http-aware-l7-policy">Docs</a><figure id="23bb8b2c-1c23-80fa-b085-d43c50883d6c" class="image"><a href="images/image%203.png"><img style="width:816px" src="images/image%203.png"/></a></figure><ul id="23bb8b2c-1c23-8025-9160-c28f737ee09f" class="bulleted-list"><li style="list-style-type:circle">위의 간단한 시나리오에서는 tiefighter / xwing에게 데스스타 API에 대한 전체 액세스 권한을 부여하거나 아예 액세스 권한을 부여하지 않는 것으로 충분했습니다. 그러나 마이크로서비스 간에 가장 강력한 보안(즉, 최소 권한 격리를 강제하는 것)을 제공하기 위해서는 데스스타 API를 호출하는 각 서비스가 <strong>합법적인 운영에 필요한 HTTP 요청 세트만 수행</strong>하도록 제한해야 합니다.</li></ul><ul id="23bb8b2c-1c23-80fc-b126-f342ad20345e" class="bulleted-list"><li style="list-style-type:circle">예를 들어, 데스스타 서비스가 임의의 제국 선박이<strong> 호출해서는 안 되는 일부 유지보수 API를 노출</strong>한다고 가정해 보겠습니다.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-806a-954c-cc94751e6173" class="code"><code class="language-Bash"># 모니터링 &gt;&gt; Layer3/4 에서는 애플리케이션 상태를 확인 할 수 없음!
# 아래와 같이 error를 return 했음에도 불구하고, 모니터링에 대한 결과가 아무것도 뜨지 않는다.
hubble observe -f --protocol tcp --from-identity $DEATHSTARID

# 호출해서는 안 되는 일부 유지보수 API를 노출
kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port
Panic: deathstar exploded

goroutine 1 [running]:
main.HandleGarbage(0x2080c3f50, 0x2, 0x4, 0x425c0, 0x5, 0xa)
        /code/src/github.com/empire/deathstar/
        temp/main.go:9 +0x64
main.main()
        /code/src/github.com/empire/deathstar/
        temp/main.go:5 +0x85</code></pre><p id="23bb8b2c-1c23-8026-8989-d859b7635cc5" class="">
</p><p id="23bb8b2c-1c23-808f-9110-cabbd29f2614" class=""><strong>L7 Policy with Cilium and Kubernetes</strong></p><ul id="23bb8b2c-1c23-80ad-bc95-d7451b1521a2" class="bulleted-list"><li style="list-style-type:circle">Cilium은 HTTP 계층(즉, L7) 정책을 적용하여 타이파이터가 도달할 수 있는 URL을 제한할 수 있습니다. 다음은 타이파이터를 POST /v1/요청-랜딩 API 호출만 수행하도록 제한하고 다른 모든 호출(PUT /v1/배기포트 포함)은 허용하지 않는 정책 파일의 예입니다.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8096-8f8a-f8285857ce41" class="code"><code class="language-Bash"># 기존 rule1 정책을 업데이트 해서 사용
# spec.ingress[].toPorts[].rules라는 정책이 추가됨!!
apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;rule1&quot;
spec:
  description: &quot;L7 policy to restrict access to specific HTTP call&quot;
  endpointSelector:
    matchLabels:
      org: empire
      class: deathstar
  ingress:
  - fromEndpoints:
    - matchLabels:
        org: empire
    toPorts:
    - ports:
      - port: &quot;80&quot;
        protocol: TCP
      rules:
        http:
        - method: &quot;POST&quot;
          path: &quot;/v1/request-landing&quot;

# Update the existing rule to apply L7-aware policy to protect deathstar using:
kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/sw_l3_l4_l7_policy.yaml
kubectl get cnp
kc describe cnp
Name:         rule1
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  cilium.io/v2
Kind:         CiliumNetworkPolicy
Metadata:
  Creation Timestamp:  2025-07-25T17:03:04Z
  Generation:          2
  Resource Version:    15549
  UID:                 8bbd32a7-9525-4c48-b0b8-f7822be73369
Spec:
  Description:  L7 policy to restrict access to specific HTTP call
  Endpoint Selector:
    Match Labels:
      Class:  deathstar
      Org:    empire
  Ingress:
    From Endpoints:
      Match Labels:
        Org:  empire
    To Ports:
      Ports:
        Port:      80
        Protocol:  TCP
      Rules:
        Http:
          Method:  POST
          Path:    /v1/request-landing
Status:
  Conditions:
    Last Transition Time:  2025-07-25T17:03:04Z
    Message:               Policy validation succeeded
    Status:                True
    Type:                  Valid

c0 policy get


# 모니터링 : 파드 이름 지정
# 정상적으로 http req / resp에 대한 로그가 보임
hubble observe -f --pod deathstar --protocol http
Jul 25 17:11:16.490: default/tiefighter:54334 (ID:2802) -&gt; default/deathstar-8c4c77fb7-w8d6w:80 (ID:1021) http-request FORWARDED (HTTP/1.1 POST http://deathstar.default.svc.cluster.local/v1/request-landing)
Jul 25 17:11:16.492: default/tiefighter:54334 (ID:2802) &lt;- default/deathstar-8c4c77fb7-w8d6w:80 (ID:1021) http-response FORWARDED (HTTP/1.1 200 2ms (POST http://deathstar.default.svc.cluster.local/v1/request-landing))

# We can now re-run the same test as above, but we will see a different outcome
# cnp의 rules에 의해 허용된 http request
kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
Ship landed
</code></pre><figure id="23bb8b2c-1c23-80fb-bcfd-c31a80d7ea3d" class="image"><a href="images/CleanShot_2025-07-20_at_10.48.03.png"><img style="width:672px" src="images/CleanShot_2025-07-20_at_10.48.03.png"/></a></figure><p id="23bb8b2c-1c23-805f-b0ae-d510dbb1315e" class="">
</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-803f-9d36-ce0c0b8ab5fd" class="code"><code class="language-Shell"># We can now re-run the same test as above, but we will see a different outcome
# cnp의 rules에 의해 허용되지 않은 /v1/exhaust-port를 호출하면 403 access denied가 뜬다!!
while true; do kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port ; sleep 5 ; done
Access denied

# 모니터링 : 파드 이름 지정
hubble observe -f --pod deathstar --verdict DROPPED
Jul 25 17:12:43.662: default/tiefighter:47936 (ID:2802) -&gt; default/deathstar-8c4c77fb7-jzqhp:80 (ID:16791) http-request DROPPED (HTTP/1.1 PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port)

혹은

c1 monitor -v --type l7
&lt;- Request http from 1618 ([k8s:app.kubernetes.io/name=tiefighter k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]) to 3012 ([k8s:app.kubernetes.io/name=deathstar k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]), identity 2802-&gt;16791, verdict Denied PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port =&gt; 0
&lt;- Response http to 1618 ([k8s:app.kubernetes.io/name=tiefighter k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]) from 3012 ([k8s:app.kubernetes.io/name=deathstar k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]), identity 16791-&gt;2802, verdict Forwarded PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port =&gt; 403

c2 monitor -v --type l7

# 호출 시도 : 아래 두 실행시, 종료의 차이점을 이해해보자!
while true; do kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port ; sleep 5 ; done
while true; do kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing --connect-timeout 2 ; sleep 5 ; done


## xwing에서 오는 traffic은 cnp의 ingress[].fromEndpoint의 label에 의해서 차단되어 tcp level에서 ingress denied라는 로그와 함께 l4에서 바로 차단됨
## 하지만 tiefighter에서 /v1/exhaust-port API에 대한 요청은 L7 http 요청이므로 L4 level에서 바로 DENIED 되지는 않고 통과후 spec.ingress[].toPorts[].rules에 의해 설정된 정책대로 L7에서 DROPPED 된다.
# TCP level DENIED
hubble observe -f --pod xwing
Jul 25 17:15:01.902: default/xwing:34988 (ID:12255) &lt;&gt; default/deathstar-8c4c77fb7-w8d6w:80 (ID:1021) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)
Jul 25 17:15:01.902: default/xwing:34988 (ID:12255) &lt;&gt; default/deathstar-8c4c77fb7-w8d6w:80 (ID:1021) Policy denied DROPPED (TCP Flags: SYN)

# HTTP(L7) level DROPPED
hubble observe -f --pod deathstar --verdict DROPPED
Jul 25 17:12:43.662: default/tiefighter:47936 (ID:2802) -&gt; default/deathstar-8c4c77fb7-jzqhp:80 (ID:16791) http-request DROPPED (HTTP/1.1 PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port)
</code></pre><figure id="23bb8b2c-1c23-809b-bf6c-ee27b3a7c8cf" class="image"><a href="images/CleanShot_2025-07-20_at_10.50.37.png"><img style="width:816px" src="images/CleanShot_2025-07-20_at_10.50.37.png"/></a></figure><p id="23bb8b2c-1c23-807c-bdc5-dcca02dac9b1" class="">
</p></li></ul><ul id="23bb8b2c-1c23-8032-b9c2-c6c620d397a2" class="bulleted-list"><li style="list-style-type:disc">다음 실습을 위해 리소스 삭제<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8028-8d2f-ca95b878688b" class="code"><code class="language-Bash"># 다음 실습을 위해 리소스 삭제
kubectl delete -f https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/http-sw-app.yaml
kubectl delete cnp rule1

# 삭제 확인
kubectl get cnp
</code></pre></li></ul><p id="23bb8b2c-1c23-80f7-9eff-f27a004cad6a" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-80a1-bb94-fa17f5215615" class="toggle"><li><details open=""><summary>1.5. Configuring <strong>Hubble exporter</strong> : 흐름 로그 - <a href="https://docs.cilium.io/en/stable/observability/hubble/configuration/export/">Docs</a></summary><ul id="23bb8b2c-1c23-8017-ab80-f12f6720b0ca" class="bulleted-list"><li style="list-style-type:disc">Hubble Exporter는 나중에 사용할 수 있도록 <strong>Hubble flows 로그를 파일</strong>에 저장할 수 있는 cilium-agent의 기능입니다. </li></ul><ul id="23bb8b2c-1c23-80e7-bcfb-d7c1ab7e78c5" class="bulleted-list"><li style="list-style-type:disc">Hubble Exporter는 file rotation, size limits, filters, field masks를 지원합니다.</li></ul><ul id="23bb8b2c-1c23-80af-b705-d783b307f2fb" class="bulleted-list"><li style="list-style-type:disc"><strong>Hubble Exporter 설정</strong> ← Hubble 설치 때 같이 적용되어 있음<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-805b-abf3-f718baecc0c0" class="code"><code class="language-Bash"># 설정 : 아래 설정할 필요 없음
helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values \
   --set hubble.enabled=true \
   --set hubble.export.static.enabled=true \
   --set hubble.export.static.filePath=/var/run/cilium/hubble/events.log

kubectl -n kube-system rollout status ds/cilium


# 확인
kubectl get cm -n kube-system cilium-config -o json | grep hubble-export
cilium config view | grep hubble-export
hubble-export-allowlist                           
hubble-export-denylist                            
hubble-export-fieldmask                           
hubble-export-file-max-backups   # number of rotated Hubble export files to keep. (default 5)
hubble-export-file-max-size-mb   # size in MB at which to rotate the Hubble export file. (default 10)
hubble-export-file-path          # file path of target log file. (default /var/run/cilium/hubble/events.log)

# Verify that flow logs are stored in target files
kubectl -n kube-system exec ds/cilium -- tail -f /var/run/cilium/hubble/events.log
kubectl -n kube-system exec ds/cilium -- sh -c &#x27;tail -f /var/run/cilium/hubble/events.log&#x27; | jq
</code></pre><p id="23bb8b2c-1c23-8003-b69e-f6a0fdefdfe5" class="">
</p></li></ul><ul id="23bb8b2c-1c23-8053-94fe-f803e127c84d" class="bulleted-list"><li style="list-style-type:disc"><strong>Performance tuning - </strong><strong><a href="https://docs.cilium.io/en/stable/observability/hubble/configuration/export/#performance-tuning">Docs</a></strong><p id="23bb8b2c-1c23-807e-8ca3-c35e257e2693" class="">Configuration options impacting performance of <strong>Hubble exporter</strong> include:</p><ul id="23bb8b2c-1c23-8062-850f-c89f67a0685b" class="bulleted-list"><li style="list-style-type:circle"><code>hubble.export.static.allowList</code>: specify an <strong>allowlist</strong> as JSON encoded FlowFilters to Hubble exporter.</li></ul><ul id="23bb8b2c-1c23-8089-ab07-fc02495d6342" class="bulleted-list"><li style="list-style-type:circle"><code>hubble.export.static.denyList</code>: specify a <strong>denylist</strong> as JSON encoded FlowFilters to Hubble exporter.</li></ul><ul id="23bb8b2c-1c23-800f-8a30-dcca5bcbf448" class="bulleted-list"><li style="list-style-type:circle"><code>hubble.export.static.fieldMask</code>: specify a <strong>list</strong> of <strong>fields</strong> to use for field masking in Hubble exporter.</li></ul><p id="23bb8b2c-1c23-8053-a958-e2a06935b407" class=""><strong>Filters &amp; Field mask</strong></p><ul id="23bb8b2c-1c23-8093-a84e-dc3a7ba9e682" class="bulleted-list"><li style="list-style-type:circle">Field mask is a list of field names from the <a href="https://github.com/cilium/cilium/blob/main/api/v1/flow/flow.proto">flow proto</a> definition.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80da-9168-f0c0c093c2b5" class="code"><code class="language-Shell"># You can use hubble CLI to generated required filters (see Specifying Raw Flow Filters for more examples).
# For example, to filter flows with verdict DENIED or ERROR, run:
hubble observe --verdict DROPPED --verdict ERROR --print-raw-filters
allowlist:
- &#x27;{&quot;verdict&quot;:[&quot;DROPPED&quot;,&quot;ERROR&quot;]}&#x27;


# To keep all information except pod labels:
hubble-export-fieldmask: time source.identity source.namespace source.pod_name destination.identity destination.namespace destination.pod_name source_service destination_service l4 IP ethernet l7 Type node_name is_reply event_type verdict Summary

# To keep only timestamp, verdict, ports, IP addresses, node name, pod name, and namespace:
hubble-export-fieldmask: time source.namespace source.pod_name destination.namespace destination.pod_name l4 IP node_name is_reply verdict

## 설정 방안 : helm 업그레이드 with values.yaml
# hubble-exporter-values.yaml
hubble:
  export:
    static:
      allowList:
        - &#x27;{&quot;verdict&quot;:[&quot;DROPPED&quot;,&quot;ERROR&quot;]}&#x27;
      denyList:
        - &#x27;{&quot;source_pod&quot;:[&quot;kube-system/&quot;]}&#x27;
        - &#x27;{&quot;destination_pod&quot;:[&quot;kube-system/&quot;]}&#x27;
      fieldMask:
        - time
        - source.namespace
        - source.pod_name
        - destination.namespace
        - destination.pod_name
        - l4
        - IP
        - node_name
        - is_reply
        - verdict
        - drop_reason_desc
        
helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values -f hubble-exporter-values.yaml

# 확인
cilium config view | grep hubble-export
hubble-export-allowlist                           {&quot;verdict&quot;:[&quot;DROPPED&quot;,&quot;ERROR&quot;]}
hubble-export-denylist                            {&quot;source_pod&quot;:[&quot;kube-system/&quot;]} {&quot;destination_pod&quot;:[&quot;kube-system/&quot;]}
hubble-export-fieldmask                           time source.namespace source.pod_name destination.namespace destination.pod_name l4 IP node_name is_reply verdict drop_reason_desc
hubble-export-file-max-backups                    5
hubble-export-file-max-size-mb                    10
hubble-export-file-path                           /var/run/cilium/hubble/events.log
...

# cilium pod가 재시작되지 않으므로 restart 시켜줘야함
kubectl rollout restart -n kube-system ds cilium

kubectl -n kube-system exec cilium-9l2dj -- tail -f /var/run/cilium/hubble/events.log
{&quot;flow&quot;:{&quot;time&quot;:&quot;2025-07-26T06:46:40.367650328Z&quot;,&quot;uuid&quot;:&quot;73a9f3d5-6fbb-4b08-bd6b-85191d08429f&quot;,&quot;verdict&quot;:&quot;FORWARDED&quot;,&quot;ethernet&quot;:{&quot;source&quot;:&quot;02:1d:ae:5f:c0:13&quot;,&quot;destination&quot;:&quot;3e:ee:60:7c:df:5d&quot;},&quot;IP&quot;:{&quot;source&quot;:&quot;192.168.10.102&quot;,&quot;destination&quot;:&quot;172.20.2.28&quot;,&quot;ipVersion&quot;:&quot;IPv4&quot;},&quot;l4&quot;:{&quot;TCP&quot;:{&quot;source_port&quot;:4244,&quot;destination_port&quot;:54306,&quot;flags&quot;:{&quot;RST&quot;:true}}},&quot;source&quot;:{&quot;identity&quot;:1,&quot;labels&quot;:[&quot;reserved:host&quot;]},&quot;destination&quot;:{&quot;ID&quot;:965,&quot;identity&quot;:12119,&quot;cluster_name&quot;:&quot;default&quot;,&quot;namespace&quot;:&quot;kube-system&quot;,&quot;labels&quot;:[&quot;k8s:app.kubernetes.io/name=hubble-relay&quot;,&quot;k8s:app.kubernetes.io/part-of=cilium&quot;,&quot;k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system&quot;,&quot;k8s:io.cilium.k8s.policy.cluster=default&quot;,&quot;k8s:io.cilium.k8s.policy.serviceaccount=hubble-relay&quot;,&quot;k8s:io.kubernetes.pod.namespace=kube-system&quot;,&quot;k8s:k8s-app=hubble-relay&quot;],&quot;pod_name&quot;:&quot;hubble-relay-5dcd46f5c-xhkqn&quot;,&quot;workloads&quot;:[{&quot;name&quot;:&quot;hubble-relay&quot;,&quot;kind&quot;:&quot;Deployment&quot;}]},&quot;Type&quot;:&quot;L3_L4&quot;,&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;reply&quot;:true,&quot;event_type&quot;:{&quot;type&quot;:4},&quot;traffic_direction&quot;:&quot;EGRESS&quot;,&quot;trace_observation_point&quot;:&quot;TO_ENDPOINT&quot;,&quot;trace_reason&quot;:&quot;REPLY&quot;,&quot;is_reply&quot;:true,&quot;interface&quot;:{&quot;index&quot;:19,&quot;name&quot;:&quot;lxc5d85ed25d6a3&quot;},&quot;Summary&quot;:&quot;TCP Flags: RST&quot;},&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;time&quot;:&quot;2025-07-26T06:46:40.367650328Z&quot;}
{&quot;flow&quot;:{&quot;time&quot;:&quot;2025-07-26T06:46:42.271635012Z&quot;,&quot;uuid&quot;:&quot;383fc258-312c-438d-b2ec-0aa3c2b21458&quot;,&quot;verdict&quot;:&quot;TRACED&quot;,&quot;IP&quot;:{&quot;source&quot;:&quot;127.0.0.1&quot;,&quot;destination&quot;:&quot;192.168.10.102&quot;,&quot;ipVersion&quot;:&quot;IPv4&quot;},&quot;l4&quot;:{&quot;TCP&quot;:{&quot;source_port&quot;:52080}},&quot;source&quot;:{&quot;identity&quot;:2,&quot;labels&quot;:[&quot;reserved:world&quot;]},&quot;destination&quot;:{&quot;identity&quot;:1,&quot;labels&quot;:[&quot;reserved:host&quot;]},&quot;Type&quot;:&quot;SOCK&quot;,&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;event_type&quot;:{&quot;type&quot;:7,&quot;sub_type&quot;:3},&quot;sock_xlate_point&quot;:&quot;SOCK_XLATE_POINT_PRE_DIRECTION_REV&quot;,&quot;socket_cookie&quot;:&quot;8388&quot;,&quot;cgroup_id&quot;:&quot;18400&quot;,&quot;Summary&quot;:&quot;TCP&quot;},&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;time&quot;:&quot;2025-07-26T06:46:42.271635012Z&quot;}
...
## restart 이후 DROPPED 관련 log만 찍힘
{&quot;flow&quot;:{&quot;time&quot;:&quot;2025-07-26T06:47:09.344769994Z&quot;,&quot;verdict&quot;:&quot;DROPPED&quot;,&quot;IP&quot;:{&quot;source&quot;:&quot;fe80::1d:aeff:fe5f:c013&quot;,&quot;destination&quot;:&quot;ff02::2&quot;,&quot;ipVersion&quot;:&quot;IPv6&quot;},&quot;l4&quot;:{&quot;ICMPv6&quot;:{&quot;type&quot;:133}},&quot;source&quot;:{},&quot;destination&quot;:{},&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;drop_reason_desc&quot;:&quot;UNSUPPORTED_L3_PROTOCOL&quot;},&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;time&quot;:&quot;2025-07-26T06:47:09.344769994Z&quot;}
{&quot;flow&quot;:{&quot;time&quot;:&quot;2025-07-26T06:47:17.536893596Z&quot;,&quot;verdict&quot;:&quot;DROPPED&quot;,&quot;IP&quot;:{&quot;source&quot;:&quot;fe80::3cee:60ff:fe7c:df5d&quot;,&quot;destination&quot;:&quot;ff02::2&quot;,&quot;ipVersion&quot;:&quot;IPv6&quot;},&quot;l4&quot;:{&quot;ICMPv6&quot;:{&quot;type&quot;:133}},&quot;source&quot;:{},&quot;destination&quot;:{},&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;drop_reason_desc&quot;:&quot;UNSUPPORTED_L3_PROTOCOL&quot;},&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;time&quot;:&quot;2025-07-26T06:47:17.536893596Z&quot;}
{&quot;flow&quot;:{&quot;time&quot;:&quot;2025-07-26T06:49:28.608655621Z&quot;,&quot;verdict&quot;:&quot;DROPPED&quot;,&quot;IP&quot;:{&quot;source&quot;:&quot;fe80::1d:aeff:fe5f:c013&quot;,&quot;destination&quot;:&quot;ff02::2&quot;,&quot;ipVersion&quot;:&quot;IPv6&quot;},&quot;l4&quot;:{&quot;ICMPv6&quot;:{&quot;type&quot;:133}},&quot;source&quot;:{},&quot;destination&quot;:{},&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;drop_reason_desc&quot;:&quot;UNSUPPORTED_L3_PROTOCOL&quot;},&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;time&quot;:&quot;2025-07-26T06:49:28.608655621Z&quot;}
{&quot;flow&quot;:{&quot;time&quot;:&quot;2025-07-26T06:49:49.089101778Z&quot;,&quot;verdict&quot;:&quot;DROPPED&quot;,&quot;IP&quot;:{&quot;source&quot;:&quot;fe80::3cee:60ff:fe7c:df5d&quot;,&quot;destination&quot;:&quot;ff02::2&quot;,&quot;ipVersion&quot;:&quot;IPv6&quot;},&quot;l4&quot;:{&quot;ICMPv6&quot;:{&quot;type&quot;:133}},&quot;source&quot;:{},&quot;destination&quot;:{},&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;drop_reason_desc&quot;:&quot;UNSUPPORTED_L3_PROTOCOL&quot;},&quot;node_name&quot;:&quot;k8s-w2&quot;,&quot;time&quot;:&quot;2025-07-26T06:49:49.089101778Z&quot;}</code></pre><p id="23bb8b2c-1c23-80ae-b842-e2fd101fc370" class="">
</p></li></ul><ul id="23bb8b2c-1c23-8045-9fa7-e739dff4ac59" class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-blue"><strong>Dynamic exporter configuration</strong></mark><strong> - </strong><strong><a href="https://docs.cilium.io/en/stable/observability/hubble/configuration/export/#dynamic-exporter-configuration">Docs</a></strong><strong> → 실습은 Skip</strong><ul id="23bb8b2c-1c23-8052-89ce-da1c99cfa111" class="bulleted-list"><li style="list-style-type:circle"><mark class="highlight-gray"><strong>Standard hubble exporter configuration</strong></mark>은 only one set of filters 허용하며 구성을 변경하려면 only one set of filters이 필요합니다.</li></ul><ul id="23bb8b2c-1c23-803d-8d49-e90209a14351" class="bulleted-list"><li style="list-style-type:circle"><mark class="highlight-blue"><strong>Dynamic flow logs</strong></mark>를 사용하면 여러 필터를 동시에 구성하고 출력을 별도의 파일에 저장할 수 있습니다. 또한 변경된 구성을 적용하기 위해 Cilium<strong> 포드 재시작이 필요하지 않습</strong>니다.</li></ul><ul id="23bb8b2c-1c23-8027-a740-efad780ec7ab" class="bulleted-list"><li style="list-style-type:circle"><strong>Dynamic Hubble Exporter</strong>는 Config Map 속성으로 활성화됩니다. 파일 경로 값을 hubble-flowlogs-config-path로 설정할 때까지 비활성화됩니다.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8047-b751-c8005ede5929" class="code"><code class="language-Shell"># 설정 
helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values \
   --set hubble.enabled=true \
   --set hubble.export.static.enabled=false \
   --set hubble.export.dynamic.enabled=true

kubectl -n kube-system rollout status ds/cilium


# 포드를 재시작할 필요 없이 흐름 로그 설정을 변경할 수 있습니다(구성 맵 전파 지연으로 인해 변경 사항을 60초 이내에 반영해야 함):
helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values \
   --set hubble.enabled=true \
   --set hubble.export.dynamic.enabled=true \
   --set hubble.export.dynamic.config.content[0].name=system \
   --set hubble.export.dynamic.config.content[0].filePath=/var/run/cilium/hubble/events-system.log \
   --set hubble.export.dynamic.config.content[0].includeFilters[0].source_pod[0]=&#x27;kube_system/&#x27; \
   --set hubble.export.dynamic.config.content[0].includeFilters[1].destination_pod[0]=&#x27;kube_system/&#x27;</code></pre><ul id="23bb8b2c-1c23-8004-8ac6-e80acb4d8b45" class="bulleted-list"><li style="list-style-type:circle">Dynamic flow logs can be configured with end property which means that it will automatically stop logging after specified date time. It supports the same field masking and filtering as static hubble exporter.</li></ul><ul id="23bb8b2c-1c23-803a-a647-c6d3b1b4ce1a" class="bulleted-list"><li style="list-style-type:circle">For max output file size and backup files dynamic exporter reuses the same settings as static one: <code>hubble.export.fileMaxSizeMb</code> and <code>hubble.export.fileMaxBackups</code></li></ul><p id="23bb8b2c-1c23-8033-97a7-c37167495a21" class="">
</p></li></ul></details></li></ul><p id="23bb8b2c-1c23-80d2-b3b0-db1fd73479c1" class="">
</p><ul id="23bb8b2c-1c23-80f7-adce-c53986c58a6c" class="bulleted-list"><li style="list-style-type:disc"><code>도전과제1</code> Dynamic exporter configuration (hubble flow logs) 로 파일 출력 후 해당 파일을 수집하여 볼 수 있는 중앙 로깅 시스템 구성해보기 ex. Loki</li></ul><ul id="23bb8b2c-1c23-8097-97d7-c684a22f5318" class="bulleted-list"><li style="list-style-type:disc"><code>도전과제2</code> Configure TLS with Hubble - <a href="https://docs.cilium.io/en/stable/observability/hubble/configuration/tls/">Docs</a></li></ul></li></ol><p id="23bb8b2c-1c23-8040-9f35-d70f5ba6d30a" class="">
</p><ol type="1" id="23bb8b2c-1c23-8036-a099-f97593a31d4d" class="numbered-list" start="2"><li>Prometheus &amp; Grafana<p id="23bb8b2c-1c23-8029-a0dc-d99651b5860d" class="">2.1. Prometheus &amp; Grafana 소개</p><ul id="23bb8b2c-1c23-806f-88db-f9de0a0be9e6" class="toggle"><li><details open=""><summary>[Q] 모니터링 <strong>monitoring</strong> 과 관측 가능성 <strong>observability(o11y)</strong> 의 정의와 차이점? <em><mark class="highlight-gray">by Grok</mark></em></summary><table id="23bb8b2c-1c23-801d-ad07-d0681c16db18" class="simple-table"><thead class="simple-table-header"><tr id="23bb8b2c-1c23-80f7-8bd1-d1f9ea776627"><th id="R=kn" class="simple-table-header-color simple-table-header"><strong>측면</strong></th><th id="{}cf" class="simple-table-header-color simple-table-header" style="width:239.1015625px"><strong>모니터링</strong></th><th id="WEXX" class="simple-table-header-color simple-table-header" style="width:237.5859375px"><strong>관측 가능성</strong></th></tr></thead><tbody><tr id="23bb8b2c-1c23-80f6-b5c2-d964d3939b2b"><td id="R=kn" class=""><strong>정의</strong></td><td id="{}cf" class="" style="width:239.1015625px">특정 메트릭 추적으로 문제 감지</td><td id="WEXX" class="" style="width:237.5859375px">외부 출력 데이터로 시스템 상태 이해</td></tr><tr id="23bb8b2c-1c23-80e2-b348-d4bade97dbd5"><td id="R=kn" class=""><strong>목표</strong></td><td id="{}cf" class="" style="width:239.1015625px">문제 발생 시 감지 및 경고</td><td id="WEXX" class="" style="width:237.5859375px">문제 원인 진단 및 시스템 최적화</td></tr><tr id="23bb8b2c-1c23-8046-9366-f243378159ab"><td id="R=kn" class=""><strong>데이터 소스</strong></td><td id="{}cf" class="" style="width:239.1015625px">미리 정의된 메트릭 (CPU, 메모리 등)</td><td id="WEXX" class="" style="width:237.5859375px">로그, 메트릭, <strong>트레이스</strong>, <strong>이벤트</strong> 등</td></tr><tr id="23bb8b2c-1c23-8007-a2b5-e0d5dce23e87"><td id="R=kn" class=""><strong>시스템 유형</strong></td><td id="{}cf" class="" style="width:239.1015625px">단순한 시스템, 잘 알려진 파라미터</td><td id="WEXX" class="" style="width:237.5859375px">복잡한 분산 시스템, 다중 컴포넌트</td></tr><tr id="23bb8b2c-1c23-804f-8627-fd545589e287"><td id="R=kn" class=""><strong>상호작용 방식</strong></td><td id="{}cf" class="" style="width:239.1015625px">정적 경고 (임계값 기반)</td><td id="WEXX" class="" style="width:237.5859375px">동적 쿼리 및 분석 (질문 기반)</td></tr></tbody></table><ul id="23bb8b2c-1c23-8064-8a5a-f62bae5fe8bb" class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-purple"><strong>모니터링</strong></mark><strong>의 정의와 특징 : 사전에 정의된 기준을 기반으로 시스템의 상태를 감시에 중점</strong><ul id="23bb8b2c-1c23-8076-8de6-f6643f890b42" class="bulleted-list"><li style="list-style-type:circle">모니터링은 IT 시스템의 운영 상태를 추적하고, 성능 지표를 수집하며, 예상치 못한 문제를 조기에 감지하는 과정입니다. <a href="https://www.techtarget.com/searchitoperations/definition/IT-monitoring">What is IT monitoring? | Definition from TechTarget</a>에 따르면, 모니터링은 하드웨어와 소프트웨어의 메트릭을 수집하여 모든 것이 정상적으로 작동하는지 확인하고, 문제를 탐지하며 해결하는 데 사용됩니다.<ul id="23bb8b2c-1c23-8026-a667-daeeee031bfc" class="bulleted-list"><li style="list-style-type:square"><strong>주요 활동</strong>: CPU 사용량, 메모리 사용량, 응답 시간, 오류율 등 특정 지표를 지속적으로 측정.</li></ul><ul id="23bb8b2c-1c23-80f9-a9fc-f59595cc0bf1" class="bulleted-list"><li style="list-style-type:square"><strong>목적</strong>: 시스템 다운타임을 방지하고, 경고를 통해 팀이 빠르게 대응할 수 있도록 함.</li></ul><ul id="23bb8b2c-1c23-80f6-8b92-d70853f04d05" class="bulleted-list"><li style="list-style-type:square"><strong>빈도</strong>: 연속적이거나 일정 간격(일간, 주간, 월간)으로 수행됨.</li></ul><ul id="23bb8b2c-1c23-8098-8610-e118c9f23207" class="bulleted-list"><li style="list-style-type:square"><strong>예시</strong>: Google의 SRE 책(<a href="https://www.splunk.com/en_us/blog/learn/it-monitoring.html">What’s IT Monitoring? IT Systems Monitoring Explained | Splunk</a>)에서는 모니터링을 &quot;시스템에 대한 실시간 정량 데이터 수집, 처리, 집계, 표시&quot;로 정의하며, 쿼리 수, 오류 수, 처리 시간 등을 포함한다고 설명합니다.</li></ul></li></ul><ul id="23bb8b2c-1c23-800d-a265-ddcf83c6c9f1" class="bulleted-list"><li style="list-style-type:circle">모니터링은 주로 단순하고 잘 알려진 시스템에 적합하며, 미리 설정된 임계값을 초과하면 알림을 발송하는 방식으로 작동합니다. 예를 들어, 서버의 CPU 사용량이 90%를 초과하면 경고가 발생할 수 있습니다.</li></ul></li></ul><ul id="23bb8b2c-1c23-8049-ad69-d165c3f0f562" class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-blue"><strong>관측 가능성</strong></mark><strong>의 정의와 특징 : 수집된 다양한 데이터를 활용하여 예측되지 않은 문제까지 분석</strong><ul id="23bb8b2c-1c23-808f-910d-c46352ed442f" class="bulleted-list"><li style="list-style-type:circle">관측 가능성은 시스템의 내부 상태를 외부 출력 데이터(로그, 메트릭, 트레이스)를 통해 이해할 수 있는 능력을 의미합니다. <a href="https://en.wikipedia.org/wiki/Observability_(software)">Observability (software) - Wikipedia</a>에 따르면, 관측 가능성은 소프트웨어 엔지니어링에서 프로그램 실행, 모듈 내부 상태, 컴포넌트 간 통신 데이터를 수집하고 분석하는 능력을 말합니다.<ul id="23bb8b2c-1c23-80a5-81ce-f431f9a7004d" class="bulleted-list"><li style="list-style-type:square"><strong>핵심 데이터</strong>: 로그(이벤트 기록), 메트릭(수치 데이터),<mark class="highlight-blue"><strong> 트레이스(요청 흐름 추적)</strong></mark>, 그리고 일부 경우 <mark class="highlight-blue">이벤트</mark>가 포함됩니다.</li></ul><ul id="23bb8b2c-1c23-802b-808a-fdf929fb244b" class="bulleted-list"><li style="list-style-type:square"><strong>목적</strong>: 복잡한 분산 시스템에서 문제를 진단하고, 새로운 문제를 탐지하며, 시스템 동작을 최적화.</li></ul><ul id="23bb8b2c-1c23-808d-a50d-ee17eb13f2b7" class="bulleted-list"><li style="list-style-type:square"><a href="https://www.ibm.com/think/topics/observability">What Is Observability? | IBM</a>에서는 관측 가능성을 &quot;복잡한 시스템의 내부 상태를 외부 출력 데이터로 이해하는 능력&quot;으로 정의하며, 특히 클라우드 환경에서 중요하다고 강조합니다.</li></ul><ul id="23bb8b2c-1c23-8030-b781-d3765f64dae0" class="bulleted-list"><li style="list-style-type:square"><strong>예시</strong>: 애플리케이션이 느려진 이유가 특정 마이크로서비스의 데이터베이스 연결 문제 때문이라는 것을 <mark class="highlight-blue">로그와 트레이스</mark>를 통해 파악.</li></ul></li></ul><ul id="23bb8b2c-1c23-80ca-8ca2-e17e722eecb7" class="bulleted-list"><li style="list-style-type:circle">관측 가능성은 특히 현대의 분산 아키텍처(예: 마이크로서비스, 컨테이너)에서 필수적이며, 미리 정의되지 않은 질문에 답할 수 있는 유연성을 제공합니다. 예를 들어, &quot;왜 이 특정 요청이 실패했는가?&quot;라는 질문을 로그와 트레이스를 통해 분석할 수 있습니다. → <mark class="highlight-blue"><strong>콘텍스트 context(문맥</strong></mark>) 정보를 제공</li></ul><ul id="23bb8b2c-1c23-8085-b9c0-f821fe0091d5" class="bulleted-list"><li style="list-style-type:circle">APM 대신 <mark class="highlight-blue"><strong>추적 tracing</strong></mark> 이라고 부르며, <mark class="highlight-blue"><strong>계측 instrumentation</strong></mark> 과 <mark class="highlight-blue"><strong>텔레메트리 telemetry</strong></mark> 라는 용어를 범용적으로 사용함.</li></ul></li></ul><ul id="23bb8b2c-1c23-805e-b56e-fb68b96487e5" class="bulleted-list"><li style="list-style-type:disc"><strong>차이점</strong><ol type="1" id="23bb8b2c-1c23-80bc-b9eb-f7f565eea12e" class="numbered-list" start="1"><li><strong>목적</strong>:<ul id="23bb8b2c-1c23-80ec-b948-cb922a3b2be3" class="bulleted-list"><li style="list-style-type:disc">모니터링: 시스템의 건강 상태를 확인하고, 문제가 발생했는지 감지. 예: 서버 다운 감지.</li></ul><ul id="23bb8b2c-1c23-808d-847a-f6d616a6314c" class="bulleted-list"><li style="list-style-type:disc">관측 가능성: 문제의 원인을 진단하고, 시스템 동작을 이해. 예: 왜 서버가 다운되었는지 분석.</li></ul></li></ol><ol type="1" id="23bb8b2c-1c23-808b-8e8d-e75f83b840d0" class="numbered-list" start="2"><li><strong>데이터 수집</strong>:<ul id="23bb8b2c-1c23-8037-b76e-c573e6dfc77e" class="bulleted-list"><li style="list-style-type:disc">모니터링: 미리 정의된 메트릭(CPU 사용량, 메모리 사용량 등)에 초점. <a href="https://www.oxfordreference.com/display/10.1093/oi/authority.20110803100205753">Monitoring - Oxford Reference</a>에서는 모니터링을 &quot;특정 프로세스의 성능 분석&quot;으로 정의.</li></ul><ul id="23bb8b2c-1c23-8010-9511-fb9a2e1276ba" class="bulleted-list"><li style="list-style-type:disc">관측 가능성: 로그, 메트릭, 트레이스 등 다양한 데이터 소스를 통합적으로 사용. <a href="https://www.dynatrace.com/news/blog/what-is-observability-2/">What is observability? Not just logs, metrics, and traces</a>에서는 이를 &quot;관측 가능성의 세 가지 기둥&quot;으로 설명.</li></ul></li></ol><ol type="1" id="23bb8b2c-1c23-804e-9e75-e9c3193cbf68" class="numbered-list" start="3"><li><strong>시스템 복잡성</strong>:<ul id="23bb8b2c-1c23-8086-b112-d817a65077fa" class="bulleted-list"><li style="list-style-type:disc">모니터링: 단순한 시스템에 적합, 예: 단일 서버 환경.</li></ul><ul id="23bb8b2c-1c23-80b1-b3a9-dc1920776073" class="bulleted-list"><li style="list-style-type:disc">관측 가능성: 복잡한 분산 시스템에 필수, 예: 마이크로서비스 아키텍처. <a href="https://www.influxdata.com/blog/observability-vs-monitoring-understanding-differences/">Observability vs. Monitoring: Understanding the Differences | InfluxData</a>에서는 분산 시스템에서 관측 가능성의 중요성을 강조.</li></ul></li></ol><ol type="1" id="23bb8b2c-1c23-80fb-8b02-f27a51b1a440" class="numbered-list" start="4"><li><strong>사용자 상호작용</strong>:<ul id="23bb8b2c-1c23-809b-a71d-c092c044a6b6" class="bulleted-list"><li style="list-style-type:disc">모니터링: 경고 기반, 예: 임계값 초과 시 알림.</li></ul><ul id="23bb8b2c-1c23-809a-8c0c-e69ef4d767e8" class="bulleted-list"><li style="list-style-type:disc">관측 가능성: 동적 쿼리 및 분석 가능, 예: 특정 로그를 검색해 문제 원인 찾기.</li></ul></li></ol></li></ul><p id="23bb8b2c-1c23-80d3-ace5-f03a21f3203f" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-8061-9107-c53806b87f9c" class="toggle"><li><details open=""><summary>observability 의 메트릭 <strong>metric</strong>, 로그 <strong>log</strong>, 추적 <strong>tracing</strong> 이란?<strong> </strong> <em><mark class="highlight-gray">by ChatGPT</mark></em></summary><table id="23bb8b2c-1c23-80cf-b706-e5303c6e6bd2" class="simple-table"><thead class="simple-table-header"><tr id="23bb8b2c-1c23-808a-a394-ee090a4f456b"><th id="kw\\" class="simple-table-header-color simple-table-header"><strong>비교 항목</strong></th><th id="j^z~" class="simple-table-header-color simple-table-header"><strong>메트릭 (Metrics)</strong></th><th id="zzNn" class="simple-table-header-color simple-table-header" style="width:264px"><strong>로그 (Logs)</strong></th><th id="@VWy" class="simple-table-header-color simple-table-header" style="width:299px"><strong>추적 (Tracing)</strong></th></tr></thead><tbody><tr id="23bb8b2c-1c23-80f5-b3a9-ef8060ccf6ce"><td id="kw\\" class="">정의</td><td id="j^z~" class="">수치로 표현된 성능 데이터</td><td id="zzNn" class="" style="width:264px">시스템 이벤트 기록</td><td id="@VWy" class="" style="width:299px">요청이 시스템을 거치는 과정 추적</td></tr><tr id="23bb8b2c-1c23-8049-bb66-cf3adcf75e71"><td id="kw\\" class="">형태</td><td id="j^z~" class="">숫자 (정량적 데이터)</td><td id="zzNn" class="" style="width:264px">텍스트 (비정형 데이터)</td><td id="@VWy" class="" style="width:299px">트랜잭션 흐름 데이터</td></tr><tr id="23bb8b2c-1c23-80a4-b36a-dc0ce3d1f0ac"><td id="kw\\" class="">예시 데이터</td><td id="j^z~" class="">CPU 사용률, 응답 시간, 요청 수</td><td id="zzNn" class="" style="width:264px">오류 메시지, 로그인 시도, API 호출 로그</td><td id="@VWy" class="" style="width:299px">A 서비스 → B 서비스 → C 서비스 요청 흐름</td></tr><tr id="23bb8b2c-1c23-80f1-8cfb-db0d6e2b6019"><td id="kw\\" class="">주요 목적</td><td id="j^z~" class="">시스템 성능 모니터링 및 알람</td><td id="zzNn" class="" style="width:264px">이벤트 분석 및 디버깅</td><td id="@VWy" class="" style="width:299px">서비스 간 호출 경로 및 병목 현상 분석</td></tr><tr id="23bb8b2c-1c23-809b-9000-d87967d26d04"><td id="kw\\" class="">저장 방식</td><td id="j^z~" class="">시계열 데이터베이스(TSDB)</td><td id="zzNn" class="" style="width:264px">로그 파일 또는 로그 관리 시스템</td><td id="@VWy" class="" style="width:299px">분산 트레이싱 시스템 (Jaeger, Zipkin)</td></tr><tr id="23bb8b2c-1c23-80f7-bf3a-f4bc366748a1"><td id="kw\\" class="">활용 도구</td><td id="j^z~" class="">Prometheus, Grafana</td><td id="zzNn" class="" style="width:264px">ELK Stack, Loki</td><td id="@VWy" class="" style="width:299px">Jaeger, Zipkin</td></tr></tbody></table><ul id="23bb8b2c-1c23-805b-a395-ef4ac30e97b4" class="bulleted-list"><li style="list-style-type:disc"><strong>메트릭(Metrics)</strong>: 시스템의 성능을 정량적으로 모니터링<ul id="23bb8b2c-1c23-80f2-a468-cbb828dbfe0b" class="bulleted-list"><li style="list-style-type:circle">메트릭은 시스템의 성능과 건강 상태를 수치로 표현한 데이터입니다. 예를 들어, CPU 사용량, 메모리 사용량, 요청 지연 시간, 오류율 등이 있습니다. 이는 시스템의 전반적인 상태를 한눈에 볼 수 있게 도와주며, 이상 징후를 빠르게 감지할 수 있습니다. 놀라운 점은 메트릭이 시간에 따른 추세를 보여주며, 대시보드와 경고 시스템에 자주 사용된다는 것입니다.</li></ul></li></ul><ul id="23bb8b2c-1c23-8013-aad2-eb40393fada5" class="bulleted-list"><li style="list-style-type:disc"><strong>로그(Logs)</strong>: 이벤트 기반의 디버깅 및 문제 분석<ul id="23bb8b2c-1c23-809b-a53e-f7819bc4a111" class="bulleted-list"><li style="list-style-type:circle">로그는 시스템에서 발생한 이벤트를 기록한 텍스트나 구조화된 데이터입니다. 특정 행동이나 오류가 발생한 시점과 이유를 자세히 알 수 있어 디버깅에 유용합니다. 예를 들어, 애플리케이션이 오류를 낼 때 로그를 통해 그 원인을 찾을 수 있습니다.</li></ul></li></ul><ul id="23bb8b2c-1c23-80d4-a11d-d60bbda7e228" class="bulleted-list"><li style="list-style-type:disc"><strong>추적(Tracing)</strong>: 분산 시스템에서 요청 흐름을 파악하고 병목 현상 분석<ul id="23bb8b2c-1c23-80e0-95fe-d650d6afb4fb" class="bulleted-list"><li style="list-style-type:circle">추적, 특히 분산 추적은 요청이 분산 시스템의 여러 구성 요소를 통해 어떻게 이동하는지 추적하는 것입니다. 이는 요청의 흐름을 시각화하고, 성능 병목 현상을 찾거나 여러 서비스에 걸친 문제를 진단하는 데 도움을 줍니다. 예를 들어, 사용자가 웹사이트에서 버튼을 클릭하면 그 요청이 백엔드 서비스를 어떻게 거치는지 알 수 있습니다.</li></ul></li></ul><p id="23bb8b2c-1c23-8069-9e3d-df2a91bc4a84" class="">
</p><p id="23bb8b2c-1c23-80e7-be8f-e21821d802f7" class=""><strong><span style="border-bottom:0.05em solid">(추가 정보) SLI, SLO, SLA</span></strong></p><table id="23bb8b2c-1c23-8084-b682-eea0b397d9e9" class="simple-table"><thead class="simple-table-header"><tr id="23bb8b2c-1c23-8072-8afc-e8112ea16cae"><th id="}Jtn" class="simple-table-header-color simple-table-header">비교 항목</th><th id="[he|" class="simple-table-header-color simple-table-header">SLI (서비스 수준 지표)</th><th id="wkuo" class="simple-table-header-color simple-table-header">SLO (서비스 수준 목표)</th><th id="Mb^o" class="simple-table-header-color simple-table-header">SLA (서비스 수준 계약)</th></tr></thead><tbody><tr id="23bb8b2c-1c23-8074-a3df-c7fa50193447"><td id="}Jtn" class=""><strong>정의</strong></td><td id="[he|" class="">서비스 성능을 측정하는 실제 값</td><td id="wkuo" class="">유지해야 하는 성능 목표</td><td id="Mb^o" class="">고객과 맺은 공식 계약</td></tr><tr id="23bb8b2c-1c23-8081-b66c-d0f9ea280ebe"><td id="}Jtn" class=""><strong>목적</strong></td><td id="[he|" class="">현재 서비스 상태를 모니터링</td><td id="wkuo" class="">내부적으로 목표 수준을 설정</td><td id="Mb^o" class="">고객과의 계약 보장</td></tr><tr id="23bb8b2c-1c23-80e9-be82-e013a31b2d69"><td id="}Jtn" class=""><strong>예제</strong></td><td id="[he|" class="">99.95%의 가용성</td><td id="wkuo" class="">99.9% 이상의 가용성 목표</td><td id="Mb^o" class="">99.9% 미만이면 환불 제공</td></tr><tr id="23bb8b2c-1c23-80b1-afe3-f4947f53e832"><td id="}Jtn" class=""><strong>법적 구속력</strong></td><td id="[he|" class="">❌ 없음</td><td id="wkuo" class="">❌ 없음</td><td id="Mb^o" class="">✅ 있음</td></tr><tr id="23bb8b2c-1c23-8054-8d4e-db01952ac15a"><td id="}Jtn" class=""><strong>위반 시 결과</strong></td><td id="[he|" class="">단순 데이터 측정</td><td id="wkuo" class="">내부 경고 및 개선 조치</td><td id="Mb^o" class="">보상금 지급, 계약 위반 가능</td></tr></tbody></table><p id="23bb8b2c-1c23-8038-9e82-ca1c072f34b5" class=""><strong>SLI (Service Level Indicator, 서비스 수준 지표)</strong><div class="indented"><ul id="23bb8b2c-1c23-809b-9cea-d44167483e1f" class="bulleted-list"><li style="list-style-type:disc">SLI는 <strong>서비스 품질을 정량적으로 측정하는 주요 성능 지표</strong>입니다.</li></ul><ul id="23bb8b2c-1c23-8060-859d-e8f3db9e24c0" class="bulleted-list"><li style="list-style-type:disc">즉, 서비스의 신뢰성과 성능을 평가하는 데 사용되는 <strong>실제 측정된 값</strong>입니다.</li></ul><ul id="23bb8b2c-1c23-8036-9d04-d02cc99aada5" class="bulleted-list"><li style="list-style-type:disc"><strong>예제</strong><ul id="23bb8b2c-1c23-8032-bc87-f44da61942dc" class="bulleted-list"><li style="list-style-type:circle"><strong>웹 서비스의 응답 시간:</strong> 100ms 이내의 응답률이 99.9%</li></ul><ul id="23bb8b2c-1c23-80b0-9618-c68c2c6ae4d9" class="bulleted-list"><li style="list-style-type:circle"><strong>가용성:</strong> 30일 동안 서비스 정상 작동 시간의 비율 (예: 99.99%)</li></ul><ul id="23bb8b2c-1c23-8002-bab5-f651918e757d" class="bulleted-list"><li style="list-style-type:circle"><strong>오류율:</strong> 총 요청 중 오류 응답(5xx, 4xx)이 발생한 비율</li></ul><ul id="23bb8b2c-1c23-80db-8eeb-cb198db282ac" class="bulleted-list"><li style="list-style-type:circle"><strong>트래픽 지연율:</strong> 네트워크 요청의 평균 응답 시간</li></ul></li></ul><p id="23bb8b2c-1c23-80d8-b64f-d15b7deecb8d" class="">📌 <strong>SLI는 측정값이므로, 실제 운영 데이터에서 계산됩니다.</strong></p></div></p><p id="23bb8b2c-1c23-8087-9117-ecf48c8c981c" class="">
</p><p id="23bb8b2c-1c23-80fb-b3ec-e5d471a4fc89" class=""><strong>SLO (Service Level Objective, 서비스 수준 목표)</strong><div class="indented"><ul id="23bb8b2c-1c23-803b-a60f-e579e5012596" class="bulleted-list"><li style="list-style-type:disc">SLO는 <strong>서비스가 유지해야 하는 목표 수준을 정의하는 값</strong>으로, SLI(실제 측정값)에 대한 **기준선(threshold)**을 설정합니다.</li></ul><ul id="23bb8b2c-1c23-80a6-8405-fc4d637c8573" class="bulleted-list"><li style="list-style-type:disc">즉, &quot;이 정도의 성능을 유지해야 한다&quot;는 목표를 의미합니다.</li></ul><ul id="23bb8b2c-1c23-805b-9441-ee48156bb01f" class="bulleted-list"><li style="list-style-type:disc"><strong>예제</strong><ul id="23bb8b2c-1c23-80c4-bce3-db7f683a5dbb" class="bulleted-list"><li style="list-style-type:circle"><strong>가용성 SLO:</strong> &quot;서비스 가용성 99.9% 이상 유지&quot;</li></ul><ul id="23bb8b2c-1c23-8081-9ab9-fa3d9fda65ff" class="bulleted-list"><li style="list-style-type:circle"><strong>응답 시간 SLO:</strong> &quot;모든 요청의 95%는 200ms 이내에 응답해야 한다&quot;</li></ul><ul id="23bb8b2c-1c23-8030-a07a-f9918b9bde01" class="bulleted-list"><li style="list-style-type:circle"><strong>오류율 SLO:</strong> &quot;오류율 0.1% 이하 유지&quot;</li></ul></li></ul><p id="23bb8b2c-1c23-80a9-bf1b-d6d28d3b3bb1" class="">📌 <strong>SLO는 내부 목표이며, SLA(계약)와 다릅니다.</strong></p></div></p><p id="23bb8b2c-1c23-805d-9b12-fcc209cdfec3" class="">
</p><p id="23bb8b2c-1c23-8080-8897-ea26115ebee3" class=""><strong>SLA (Service Level Agreement, 서비스 수준 계약)</strong><div class="indented"><ul id="23bb8b2c-1c23-803b-8b23-f0903076fb72" class="bulleted-list"><li style="list-style-type:disc">SLA는 <strong>서비스 제공자와 고객 간에 체결된 공식적인 계약</strong>으로, 서비스 품질을 보장하는 <strong>법적 문서</strong>입니다.</li></ul><ul id="23bb8b2c-1c23-807c-81a7-db5792010f38" class="bulleted-list"><li style="list-style-type:disc">SLA는 SLO와 달리 계약 위반 시 **페널티(배상)**가 존재할 수 있습니다.</li></ul><ul id="23bb8b2c-1c23-80c2-aa56-f74c0a4c5f53" class="bulleted-list"><li style="list-style-type:disc"><strong>예제</strong><ul id="23bb8b2c-1c23-8065-bd70-ef8805f642f9" class="bulleted-list"><li style="list-style-type:circle"><strong>가용성 SLA:</strong> &quot;서비스 가용성이 99.9% 미만이면, 고객에게 요금의 10% 환불&quot;</li></ul><ul id="23bb8b2c-1c23-804c-b4d9-fe8021a8a15b" class="bulleted-list"><li style="list-style-type:circle"><strong>응답 시간 SLA:</strong> &quot;트랜잭션 응답 시간이 500ms를 초과하면, 서비스 제공자가 손해 배상&quot;</li></ul></li></ul><p id="23bb8b2c-1c23-8010-a7db-d5e4e74570b3" class="">📌 <strong>SLA는 법적 계약이므로, 위반 시 금전적 보상이 따를 수 있습니다.</strong></p></div></p><figure id="23bb8b2c-1c23-8027-8939-f6b310863fd1"><a href="https://techblog.lycorp.co.jp/ko/sli-and-slo-for-improving-reliability-1" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">신뢰성 향상을 위한 SLI/SLO 도입 1편 - 소개와 필요성</div><div class="bookmark-description">시작하며 안녕하세요. SRE(site reliability engineering, 사이트 안정성 엔지니어링) 업무를 맡고 있는 Enablement Engineering 팀 어다희,...</div></div><div class="bookmark-href"><img src="https://techblog.lycorp.co.jp/favicon.ico" class="icon bookmark-icon"/>https://techblog.lycorp.co.jp/ko/sli-and-slo-for-improving-reliability-1</div></div><img src="https://techblog.lycorp.co.jp/static/4d9e5905966eb08ba0abff992498fb9f/7d66e/54e6f4f8af2c4c80b721df9609312c0a.png" class="bookmark-image"/></a></figure><figure id="23bb8b2c-1c23-80d2-b0c3-ea0ccd207db9"><a href="https://techblog.lycorp.co.jp/ko/sli-and-slo-for-improving-reliability-2" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">신뢰성 향상을 위한 SLI/SLO 도입 2편 - 플랫폼 적용 사례</div><div class="bookmark-description">시작하며 안녕하세요. Enablement Engineering 팀에서 SRE(site reliability engineer)로 일하고 있는 어다희입니다. 저희 팀은 LINE 서비스...</div></div><div class="bookmark-href"><img src="https://techblog.lycorp.co.jp/favicon.ico" class="icon bookmark-icon"/>https://techblog.lycorp.co.jp/ko/sli-and-slo-for-improving-reliability-2</div></div><img src="https://techblog.lycorp.co.jp/static/29f4c6b9234ebc8b7e06a8332d3b7357/7d66e/eca21679dc074bad87ced934cf913d9e.png" class="bookmark-image"/></a></figure><p id="23bb8b2c-1c23-800c-8171-ec44a274698b" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-8007-8eba-da97345e5927" class="bulleted-list"><li style="list-style-type:disc"><strong>[추천글]</strong> 악분님 <strong>프로메테우스 오퍼레이터 소개</strong> - <a href="https://malwareanalysis.tistory.com/566">Blog</a> , hanhorang님 타노스 소개 - <a href="https://hanhorang31.github.io/post/pkos2-4-monitoring/">Blog</a></li></ul><ul id="23bb8b2c-1c23-80c4-8d86-d2c46681eda1" class="toggle"><li><details open=""><summary>참고 [AWS EC2] 프로메테우스 직접 설치 - <a href="https://prometheus.io/docs/prometheus/latest/getting_started/">Docs</a></summary><ul id="23bb8b2c-1c23-801b-bca5-c51882570f1e" class="bulleted-list"><li style="list-style-type:disc">prometheus 설치<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80a1-abc6-c3bd25cb70f3" class="code"><code class="language-Bash"># 최신 버전 다운로드
wget https://github.com/prometheus/prometheus/releases/download/v3.2.0/prometheus-3.2.0.linux-amd64.tar.gz

# 압축 해제
tar -xvf prometheus-3.2.0.linux-amd64.tar.gz
cd prometheus-3.2.0.linux-amd64
ls -l

#
mv prometheus /usr/local/bin/
mv promtool /usr/local/bin/
mkdir -p /etc/prometheus /var/lib/prometheus
mv prometheus.yml /etc/prometheus/
cat /etc/prometheus/prometheus.yml

#
useradd --no-create-home --shell /sbin/nologin prometheus
chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus
chown prometheus:prometheus /usr/local/bin/prometheus /usr/local/bin/promtool

#
tee /etc/systemd/system/prometheus.service &gt; /dev/null &lt;&lt;EOF
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/var/lib/prometheus \
  --web.listen-address=0.0.0.0:9090

[Install]
WantedBy=multi-user.target
EOF

#
systemctl daemon-reload
systemctl enable --now prometheus
systemctl status prometheus
ss -tnlp

#
curl localhost:9090/metrics
echo -e &quot;http://$(curl -s ipinfo.io/ip):9090&quot;
</code></pre></li></ul><ul id="23bb8b2c-1c23-80cb-96c7-dedf6234d76b" class="bulleted-list"><li style="list-style-type:disc">node_exporter 설치 - <a href="https://github.com/prometheus/node_exporter">Github</a><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-806f-a8d3-d58f3c8564f7" class="code"><code class="language-Bash"># Node Exporter 최신 버전 다운로드
cd ~
wget https://github.com/prometheus/node_exporter/releases/download/v1.9.0/node_exporter-1.9.0.linux-amd64.tar.gz
tar xvfz node_exporter-1.9.0.linux-amd64.tar.gz
cd node_exporter-1.9.0.linux-amd64
cp node_exporter /usr/local/bin/

#
groupadd -f node_exporter
useradd -g node_exporter --no-create-home --shell /sbin/nologin node_exporter
chown node_exporter:node_exporter /usr/local/bin/node_exporter

#
tee /etc/systemd/system/node_exporter.service &gt; /dev/null &lt;&lt;EOF
[Unit]
Description=Node Exporter
Documentation=https://prometheus.io/docs/guides/node-exporter/
Wants=network-online.target
After=network-online.target

[Service]
User=node_exporter
Group=node_exporter
Type=simple
Restart=on-failure
ExecStart=/usr/local/bin/node_exporter \
  --web.listen-address=:9200

[Install]
WantedBy=multi-user.target
EOF

# 데몬 실행
systemctl daemon-reload
systemctl enable --now node_exporter
systemctl status node_exporter
ss -tnlp

#
curl localhost:9200/metrics</code></pre></li></ul><ul id="23bb8b2c-1c23-80df-acd1-f263394e4313" class="bulleted-list"><li style="list-style-type:disc">prometheus 설정에 수집 대상 target (node_exporter) 추가<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-801c-a124-e5354f643c09" class="code"><code class="language-Bash"># prometheus.yml 수정
cat &lt;&lt; EOF &gt;&gt; /etc/prometheus/prometheus.yml

  - job_name: &#x27;node_exporter&#x27;
    static_configs:
      - targets: [&quot;127.0.0.1:9200&quot;]
        labels:
          alias: &#x27;myec2&#x27;
EOF

# prometheus 데몬 재기동
systemctl restart prometheus.service
systemctl status prometheus</code></pre></li></ul><ul id="23bb8b2c-1c23-8069-9fab-d26bd8e9d553" class="bulleted-list"><li style="list-style-type:disc">prometheus 웹에서 target 확인 및 node 로 시작되는 메트릭 쿼리 해보기<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80f3-b859-caf5816578f9" class="code"><code class="language-Bash">rate(node_cpu_seconds_total{mode=&quot;system&quot;}[1m])
node_filesystem_avail_bytes
rate(node_network_receive_bytes_total[1m])</code></pre></li></ul><p id="23bb8b2c-1c23-80d7-8af5-e378b94a5429" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-807e-8248-debfdef6633d" class="toggle"><li><details open=""><summary><code>소개</code> : <a href="https://github.com/prometheus">Prometheus</a> is an <strong>open-source</strong> systems <strong>monitoring</strong> and <strong>alerting</strong> toolkit originally built at <a href="https://soundcloud.com/">SoundCloud</a></summary><p id="23bb8b2c-1c23-8024-ac95-e4fa1438505f" class=""><code>제공 기능</code><div class="indented"><ul id="23bb8b2c-1c23-80a4-a862-ee21c45f1e05" class="bulleted-list"><li style="list-style-type:disc">a multi-dimensional <a href="https://prometheus.io/docs/concepts/data_model/">data model</a> with <mark class="highlight-blue"><strong>time series data</strong></mark>(=<strong>TSDB, 시계열 데이터베이스</strong>) identified by metric name and <strong>key/value</strong> pairs</li></ul><ul id="23bb8b2c-1c23-803a-9794-de5d6858d829" class="bulleted-list"><li style="list-style-type:disc"><strong>PromQL</strong>, a <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">flexible query language</a> to leverage this dimensionality</li></ul><ul id="23bb8b2c-1c23-8056-af47-e337cc9ab27f" class="bulleted-list"><li style="list-style-type:disc"><strong>no reliance on distributed storage</strong>; single server nodes are autonomous - <a href="https://prometheus.io/docs/prometheus/latest/storage/">Docs</a></li></ul><ul id="23bb8b2c-1c23-8096-af6c-dad5be1162e9" class="bulleted-list"><li style="list-style-type:disc">time series collection happens via a <mark class="highlight-red"><strong>pull</strong></mark> model over <strong>HTTP - </strong><a href="https://prometheus.io/docs/introduction/faq/#why-do-you-pull-rather-than-push">Q&amp;A</a> ⇒ <mark class="highlight-red"><strong>질문</strong></mark> <strong>Push</strong> 와 <strong>Pull</strong> 수집 방식 장단점?</li></ul><ul id="23bb8b2c-1c23-809b-9c6e-d78855e17baf" class="bulleted-list"><li style="list-style-type:disc"><a href="https://prometheus.io/docs/instrumenting/pushing/">pushing time series</a> is supported via an intermediary gateway</li></ul><ul id="23bb8b2c-1c23-805b-8176-f4f44533e780" class="bulleted-list"><li style="list-style-type:disc">targets are discovered via <strong>service discovery</strong> or <strong>static</strong> configuration</li></ul><ul id="23bb8b2c-1c23-8081-aa93-e1774d482460" class="bulleted-list"><li style="list-style-type:disc">multiple modes of <strong>graphing</strong> and <strong>dashboarding</strong> support</li></ul></div></p><figure id="23bb8b2c-1c23-80a5-a316-fd428a6054f1" class="image"><a href="images/Untitled.png"><img style="width:1008px" src="images/Untitled.png"/></a><figcaption><a href="https://prometheus.io/docs/introduction/overview/">https://prometheus.io/docs/introduction/overview/</a></figcaption></figure><p id="23bb8b2c-1c23-808b-a08d-e26e4366889d" class=""><code>구성 요소</code><div class="indented"><ul id="23bb8b2c-1c23-8062-8d0b-fb954080faea" class="bulleted-list"><li style="list-style-type:disc">the main <strong><a href="https://github.com/prometheus/prometheus">Prometheus server</a></strong> which scrapes and stores <strong>time series data</strong></li></ul><ul id="23bb8b2c-1c23-8067-8256-f06a9e6bc34a" class="bulleted-list"><li style="list-style-type:disc"><strong><a href="https://prometheus.io/docs/instrumenting/clientlibs/">client libraries</a></strong> for instrumenting application code</li></ul><ul id="23bb8b2c-1c23-8025-96ea-d1f4307eb838" class="bulleted-list"><li style="list-style-type:disc">a <strong><a href="https://github.com/prometheus/pushgateway">push gateway</a></strong> for supporting short-lived jobs</li></ul><ul id="23bb8b2c-1c23-8047-b2b4-e3c452a3abd7" class="bulleted-list"><li style="list-style-type:disc">special-purpose <strong><a href="https://prometheus.io/docs/instrumenting/exporters/">exporters</a></strong> for services like HAProxy, StatsD, Graphite, etc.</li></ul><ul id="23bb8b2c-1c23-8059-92bf-d473b64b1725" class="bulleted-list"><li style="list-style-type:disc">an <strong><a href="https://github.com/prometheus/alertmanager">alertmanager</a></strong> to handle alerts</li></ul><ul id="23bb8b2c-1c23-801d-b773-ca1ee1d5d94c" class="bulleted-list"><li style="list-style-type:disc">various support tools</li></ul></div></p><p id="23bb8b2c-1c23-8065-9368-dd8a00e26370" class=""><code>Metrics</code><div class="indented"><ul id="23bb8b2c-1c23-80a1-927c-fef1de03db1f" class="bulleted-list"><li style="list-style-type:disc">메트릭은 일반인이 이해하기 쉬운 수치적 측정입니다. 시계열이라는 용어는 시간에 따른 변화를 기록하는 것을 말합니다. 사용자가 측정하고자 하는 것은 애플리케이션마다 다릅니다. 웹 서버의 경우 요청 시간이 될 수 있고, 데이터베이스의 경우 활성 연결 또는 활성 쿼리 수가 될 수 있습니다.<ul id="23bb8b2c-1c23-8027-86ad-f6ec10c23216" class="bulleted-list"><li style="list-style-type:circle"><strong>Metrics</strong> are <strong>numerical</strong> <strong>measurements</strong> in layperson terms. The term <strong>time series</strong> refers to the recording of <strong>changes over time</strong>. What users want to measure differs from application to application. For a web server, it could be request times; for a database, it could be the number of active connections or active queries, and so on.</li></ul></li></ul></div></p><figure id="23bb8b2c-1c23-805c-b927-d9ed04eca4f6" class="image"><a href="images/Untitled%201.png"><img style="width:960px" src="images/Untitled%201.png"/></a><figcaption><a href="https://github.com/prometheus/prometheus/blob/86a7064/documentation/internal_architecture.md">https://github.com/prometheus/prometheus/blob/86a7064/documentation/internal_architecture.md</a></figcaption></figure><p id="23bb8b2c-1c23-8069-9c1c-d332e40c2237" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-8082-892c-e68099cc5879" class="bulleted-list"><li style="list-style-type:disc"><strong>프로메테우스 </strong><mark class="highlight-blue"><strong>3.0</strong></mark><strong> 출시</strong> : 2.0, 2.18 버전 대비 처리 성능(CPU/Mem) 향상 - <a href="https://prometheus.io/blog/2024/11/14/prometheus-3-0/">Blog</a> , <a href="https://devocean.sk.com/blog/techBoardDetail.do?ID=167141&amp;boardType=techBlog">DevOcean</a> , <a href="https://news.hada.io/topic?id=18043">GeekNews</a> , <a href="https://www.youtube.com/watch?v=D0jE4BSzX3Y">Youtube</a></li></ul><p id="23bb8b2c-1c23-808b-94b0-d59dfddc646e" class="">
</p><p id="23bb8b2c-1c23-80b1-9181-dbabe38c6489" class="">2.2. Prometheus &amp; Grafana with Cilium 실습</p><ul id="23bb8b2c-1c23-80e2-9d2d-cc3ae2d2f195" class="bulleted-list"><li style="list-style-type:disc">eCHO Episode 68: Cilium &amp; <strong>Grafana</strong> - <a href="https://www.youtube.com/watch?v=HNxJyabrQfg">Link</a></li></ul><ul id="23bb8b2c-1c23-804d-b2c6-f0cf6ad77e3e" class="toggle"><li><details open=""><summary><strong>샘플 애플리케이션 배포 및 확인</strong></summary><ul id="23bb8b2c-1c23-8054-adfd-ecc38ea30e8c" class="bulleted-list"><li style="list-style-type:disc">샘플 애플리케이션 배포<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8060-8a98-cc9d3a730781" class="code"><code class="language-Bash"># 샘플 애플리케이션 배포
cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: &quot;kubernetes.io/hostname&quot;
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
EOF


# k8s-ctr 노드에 curl-pod 파드 배포
cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: [&quot;tail&quot;]
    args: [&quot;-f&quot;, &quot;/dev/null&quot;]
  terminationGracePeriodSeconds: 0
EOF</code></pre><p id="23bb8b2c-1c23-806b-a5ee-c56675491547" class="">
</p></li></ul><ul id="23bb8b2c-1c23-809e-af03-e02572a90229" class="bulleted-list"><li style="list-style-type:disc">확인<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-807a-adef-d2cabd41290f" class="code"><code class="language-Shell"># 배포 확인
kubectl get deploy,svc,ep webpod -owide
kubectl get endpointslices -l app=webpod
kubectl get ciliumendpoints

kubectl get po -n kube-system
NAME                               READY   STATUS    RESTARTS   AGE
cilium-66scd                       1/1     Running   0          14m
cilium-954zb                       1/1     Running   0          14m
cilium-lw6gd                       1/1     Running   0          14m
...

kubectl exec -it -n kube-system ds/cilium -c cilium-agent -- cilium-dbg endpoint list
ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                                                     
465        Disabled           Disabled          12737      k8s:app=webpod                                                                      172.20.1.52    ready   
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
852        Disabled           Disabled          42621      k8s:app.kubernetes.io/name=hubble-ui                                                172.20.1.224   ready   
                                                           k8s:app.kubernetes.io/part-of=cilium                                                                       
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                                 
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui                                                          
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                
                                                           k8s:k8s-app=hubble-ui                                                                                      
1226       Disabled           Disabled          1          reserved:host  

# 통신 확인
kubectl exec -it curl-pod -- curl webpod | grep Hostname
kubectl exec -it curl-pod -- sh -c &#x27;while true; do curl -s webpod | grep Hostname; sleep 1; done&#x27;
</code></pre></li></ul><p id="23bb8b2c-1c23-804e-ac09-de44ce88f388" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-801b-b655-d0783b449de7" class="toggle"><li><details open=""><summary><strong>Install Prometheus &amp; Grafana - </strong><strong><a href="https://docs.cilium.io/en/stable/observability/grafana/">Docs</a></strong></summary><p id="23bb8b2c-1c23-8084-ba68-ed43527e5d37" class="">This is an example deployment that includes Prometheus and Grafana in a <strong>single deployment</strong>. - <a href="https://www.youtube.com/watch?v=DdWksYq5Pv4">Youtube</a></p><ul id="23bb8b2c-1c23-80fb-af44-eb156b0cbec1" class="bulleted-list"><li style="list-style-type:disc"><strong>Grafana</strong>: A visualization dashboard with <strong>Cilium Dashboard pre-loaded.</strong></li></ul><ul id="23bb8b2c-1c23-8052-8180-fe64f5bbd9e6" class="bulleted-list"><li style="list-style-type:disc"><strong>Prometheus</strong>: a time series database and monitoring system.</li></ul><ul id="23bb8b2c-1c23-801e-8e5b-c3fe90667def" class="bulleted-list"><li style="list-style-type:disc">This example deployment of Prometheus and Grafana will <strong>automatically scrape</strong> the <strong>Cilium</strong> and <strong>Hubble metrics</strong>.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80aa-8021-d52a6770dd16" class="code"><code class="language-Shell">#
kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/kubernetes/addons/prometheus/monitoring-example.yaml
configmap/grafana-config created
configmap/grafana-cilium-dashboard created
configmap/grafana-cilium-operator-dashboard created
configmap/grafana-hubble-dashboard created
configmap/grafana-hubble-l7-http-metrics-by-workload created
configmap/prometheus created

#
kubectl get deploy,pod,svc,ep -n cilium-monitoring
NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/grafana      1/1     1            1           35s
deployment.apps/prometheus   1/1     1            1           35s

NAME                              READY   STATUS    RESTARTS   AGE
pod/grafana-5c69859d9-4f62q       1/1     Running   0          35s
pod/prometheus-6fc896bc5d-llkrm   1/1     Running   0          35s

NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/grafana      ClusterIP   10.96.131.27    &lt;none&gt;        3000/TCP   35s
service/prometheus   ClusterIP   10.96.113.158   &lt;none&gt;        9090/TCP   35s

NAME                   ENDPOINTS           AGE
endpoints/grafana      172.20.2.241:3000   35s
endpoints/prometheus   172.20.2.64:9090    35s

kubectl get cm -n cilium-monitoring
NAME                                         DATA   AGE
grafana-cilium-dashboard                     1      47s
grafana-cilium-operator-dashboard            1      47s
grafana-config                               3      47s
grafana-hubble-dashboard                     1      47s
grafana-hubble-l7-http-metrics-by-workload   1      47s
kube-root-ca.crt                             1      47s
prometheus                                   1      47s

# 프로메테우스 서버 설정
kc describe cm -n cilium-monitoring prometheus

# 그라파나 서버 설정
kc describe cm -n cilium-monitoring grafana-config

# 그파라나 대시보드들 주입을 위한 설정
kc describe cm -n cilium-monitoring grafana-cilium-dashboard
kc describe cm -n cilium-monitoring grafana-hubble-dashboard
...</code></pre><p id="23bb8b2c-1c23-8049-a291-f5816dd63e34" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-80e9-bf8f-f4610b48f386" class="toggle"><li><details open=""><summary><strong>Deploy Cilium and Hubble with metrics enabled - </strong><strong><a href="https://docs.cilium.io/en/stable/observability/grafana/#deploy-cilium-and-hubble-with-metrics-enabled">Docs</a></strong></summary><ul id="23bb8b2c-1c23-8037-81a5-f0848b6bda04" class="bulleted-list"><li style="list-style-type:disc">Cilium, Hubble, and Cilium Operator는 기본적으로 메트릭을 노출하지 않습니다. </li></ul><ul id="23bb8b2c-1c23-80a4-a8e1-e55668f2c4f4" class="bulleted-list"><li style="list-style-type:disc">이러한 서비스에 대한 메트릭을 활성화하면 이러한 구성 요소가 실행 중인 클러스터의 모든 노드에 각각 <strong>9962, 9965, 9963</strong> 포트가 열립니다.</li></ul><ul id="23bb8b2c-1c23-80b9-8903-c8d19576bd8b" class="bulleted-list"><li style="list-style-type:disc">Cilium, Hubble, and Cilium Operator의 메트릭은 모두 다음 헬름 값으로 서로 독립적으로 활성화할 수 있습니다<ul id="23bb8b2c-1c23-80ff-90ce-d952759d436b" class="bulleted-list"><li style="list-style-type:circle"><code>prometheus.enabled=true</code>: Enables metrics for <code>cilium-agent</code>.</li></ul><ul id="23bb8b2c-1c23-80d9-8f72-d8bcc6e6b7b4" class="bulleted-list"><li style="list-style-type:circle"><code>operator.prometheus.enabled=true</code>: Enables metrics for <code>cilium-operator</code>.</li></ul><ul id="23bb8b2c-1c23-808a-b36f-efaa1e727075" class="bulleted-list"><li style="list-style-type:circle"><code>hubble.metrics.enabled</code>: Enables the provided list of Hubble metrics. <ul id="23bb8b2c-1c23-80a2-9d82-e3352b3223d3" class="bulleted-list"><li style="list-style-type:square">For Hubble metrics to work, Hubble itself needs to be enabled with <code>hubble.enabled=true</code>. </li></ul><ul id="23bb8b2c-1c23-804e-83d0-f8d2611c2660" class="bulleted-list"><li style="list-style-type:square">See <a href="https://docs.cilium.io/en/stable/observability/metrics/#hubble-exported-metrics">Hubble exported metrics</a> for the list of available Hubble metrics.</li></ul></li></ul><p id="23bb8b2c-1c23-8097-8c6f-c16071e0c44f" class=""><em>→ Refer to </em><em><a href="https://docs.cilium.io/en/stable/observability/metrics/#metrics">Monitoring &amp; Metrics</a></em><em> for more details about the individual metrics.</em></p></li></ul><ul id="23bb8b2c-1c23-8025-996a-e9db99dd4c0c" class="bulleted-list"><li style="list-style-type:disc"><strong>메트릭 노출 설정 → 이미 되어 있음</strong><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80f5-9e24-d2d07c4fea18" class="code"><code class="language-Shell"># 이미 설정되어 있음
helm install cilium cilium/cilium --version 1.17.6 \
   --namespace kube-system \
   --set prometheus.enabled=true \
   --set operator.prometheus.enabled=true \
   --set hubble.enabled=true \
   --set hubble.metrics.enableOpenMetrics=true \
   --set hubble.metrics.enabled=&quot;{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\,source_namespace\,source_workload\,destination_ip\,destination_namespace\,destination_workload\,traffic_direction}&quot;

# 호스트에 포트 정보 확인
ss -tnlp | grep -E &#x27;9962|9963|9965&#x27;
LISTEN 0      4096                *:9965             *:*    users:((&quot;cilium-agent&quot;,pid=38119,fd=45))   # cilium-opeator 메트릭                    
LISTEN 0      4096                *:9962             *:*    users:((&quot;cilium-agent&quot;,pid=38119,fd=7))    # cilium 메트릭              
LISTEN 0      4096                *:9963             *:*    users:((&quot;cilium-operator&quot;,pid=23887,fd=7)) # hubble 메트릭

for i in w1 w2 ; do echo &quot;&gt;&gt; node : k8s-$i &lt;&lt;&quot;; sshpass -p &#x27;vagrant&#x27; ssh vagrant@k8s-$i sudo ss -tnlp | grep -E &#x27;9962|9963|9965&#x27; ; echo; done
</code></pre></li></ul><p id="23bb8b2c-1c23-80ba-b1a2-c3f6357c4193" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-8078-8308-d2583b18e551" class="toggle"><li><details open=""><summary>hostPC에서 <strong>접속을 위한 NodePort 설정</strong> 및 ‘<strong>프로메테우스 &amp; 그라파나</strong>’ <strong>웹 접속 확인 &amp; </strong><mark class="highlight-blue"><strong>간단 쿼리문 알아보기!</strong></mark></summary><ul id="23bb8b2c-1c23-8044-ac26-e2e6c1168f31" class="bulleted-list"><li style="list-style-type:disc">hostPC에서 접속을 위한 NodePort 설정<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8058-8650-d639eb56e9e7" class="code"><code class="language-Shell">#
kubectl get svc -n cilium-monitoring
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
grafana      ClusterIP   10.96.131.27    &lt;none&gt;        3000/TCP   5m34s
prometheus   ClusterIP   10.96.113.158   &lt;none&gt;        9090/TCP   5m34s

# NodePort 설정
kubectl patch svc -n cilium-monitoring prometheus -p &#x27;{&quot;spec&quot;: {&quot;type&quot;: &quot;NodePort&quot;, &quot;ports&quot;: [{&quot;port&quot;: 9090, &quot;targetPort&quot;: 9090, &quot;nodePort&quot;: 30001}]}}&#x27;
kubectl patch svc -n cilium-monitoring grafana -p &#x27;{&quot;spec&quot;: {&quot;type&quot;: &quot;NodePort&quot;, &quot;ports&quot;: [{&quot;port&quot;: 3000, &quot;targetPort&quot;: 3000, &quot;nodePort&quot;: 30002}]}}&#x27;

# 확인
kubectl get svc -n cilium-monitoring
NAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
grafana      NodePort   10.96.131.27    &lt;none&gt;        3000:30002/TCP   5m50s
prometheus   NodePort   10.96.113.158   &lt;none&gt;        9090:30001/TCP   5m50s

# 접속 주소 확인
echo &quot;http://192.168.10.100:30001&quot;  # prometheus
echo &quot;http://192.168.10.100:30002&quot;  # grafana
</code></pre><ul id="23bb8b2c-1c23-80a2-b9bf-d63d48ca9cfa" class="toggle"><li><details open=""><summary>(참고) 프로메테우스 파드 웹 접속 시, 서버와 브라우저간 시간 차이 발생 시</summary><figure id="23bb8b2c-1c23-8050-8434-e01c7ce4d558" class="image"><a href="images/CleanShot_2025-07-20_at_14.31.50.png"><img style="width:976.953125px" src="images/CleanShot_2025-07-20_at_14.31.50.png"/></a></figure><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-805a-9834-ec75eab76493" class="code"><code class="language-Bash"># 프로메테우스 파드 내에서 시간 : 05:19
kubectl exec -it -n cilium-monitoring deploy/prometheus -- date
Sun Jul 20 05:19:11 UTC 2025

# k8s-ctr 서버 내에서 시간 : 02:19
root@k8s-ctr:~# date
Sun Jul 20 02:19:20 PM KST 2025

# 호스트 PC(웹 브라우저 접속 시 시간 차이)에서 시간 : 14:32 &gt;&gt; 대략 11분 정도 차이 발생 중 
date                                                          
Sun Jul 20 14:32:17 KST 2025

# 해결
모든 가상머신 reboot 후 재접속 시 문제 해결됨</code></pre><p id="23bb8b2c-1c23-8080-b437-fa6defd62995" class="">
</p></details></li></ul><p id="23bb8b2c-1c23-804f-aae4-cd8e6fc53ade" class="">
</p></li></ul><ul id="23bb8b2c-1c23-8026-93fa-ec8a447e867a" class="bulleted-list"><li style="list-style-type:disc"><strong>프로메테우스 웹</strong><ul id="23bb8b2c-1c23-808e-8739-cadeb2107213" class="bulleted-list"><li style="list-style-type:circle"><strong>Status</strong> : Configuration → Service Discovery → Targets<em><mark class="highlight-gray"> ⇒ 메트릭 수집 과정은 아래 3절에서 소개!</mark></em></li></ul><ul id="23bb8b2c-1c23-8007-b28a-ce03f4ab02fb" class="bulleted-list"><li style="list-style-type:circle"><strong>기본(쿼리창)</strong> : <strong>cilium_</strong> , <strong>cilium_operator_</strong> , <strong>hubble_</strong><figure id="23bb8b2c-1c23-800c-ae24-de570e639f5a" class="image"><a href="images/CleanShot_2025-07-20_at_14.43.19.png"><img style="width:864px" src="images/CleanShot_2025-07-20_at_14.43.19.png"/></a><figcaption>hubble_drop_total</figcaption></figure><p id="23bb8b2c-1c23-8096-a727-ea5d28b8c632" class="">
</p></li></ul></li></ul><ul id="23bb8b2c-1c23-80f9-b3ee-d3ee6577f0a6" class="bulleted-list"><li style="list-style-type:disc"><strong>그라파나 웹</strong><ul id="23bb8b2c-1c23-8059-90bc-e55bbedc5f67" class="bulleted-list"><li style="list-style-type:circle">설정 → Data sources : 프로메테우스 서비스 도메인 주소 확인<figure id="23bb8b2c-1c23-8076-807e-d7d83411433e" class="image"><a href="images/CleanShot_2025-07-20_at_14.46.20.png"><img style="width:370px" src="images/CleanShot_2025-07-20_at_14.46.20.png"/></a></figure></li></ul><ul id="23bb8b2c-1c23-8082-882d-e5c54234beea" class="bulleted-list"><li style="list-style-type:circle">대시보드 → General 클릭 : 미리 주입된 대시보드들 확인<figure id="23bb8b2c-1c23-8072-91cf-e5d56f467789" class="image"><a href="images/CleanShot_2025-07-20_at_14.47.04.png"><img style="width:384.98577880859375px" src="images/CleanShot_2025-07-20_at_14.47.04.png"/></a></figure><p id="23bb8b2c-1c23-80e9-b17a-cfa201a8a467" class="">
</p></li></ul><ul id="23bb8b2c-1c23-805c-8088-fa6e9c828452" class="toggle"><li><details open=""><summary><strong>Cilium Metrics 대시보드 &amp; </strong><mark class="highlight-blue"><strong>간단 쿼리문 알아보기!</strong></mark> : Generic, API, Cilium(BPF, kvstore, NW info, Endpoints, k8s integration)</summary><ul id="23bb8b2c-1c23-80ff-895d-e530a5ce4ccc" class="bulleted-list"><li style="list-style-type:disc">map ops (average node) 패널 분석<figure id="23bb8b2c-1c23-80fb-b206-c4b4f89a0b46" class="image"><a href="images/CleanShot_2025-07-20_at_14.53.28.png"><img style="width:720px" src="images/CleanShot_2025-07-20_at_14.53.28.png"/></a></figure><p id="23bb8b2c-1c23-8079-ad4e-e6befc535d6f" class="">
</p><ul id="23bb8b2c-1c23-802e-b4b6-cdff95161d19" class="bulleted-list"><li style="list-style-type:circle">아래 쿼리문 이해해보자!</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-8067-8e39-d3a7d7e718b1" class="code"><code class="language-Bash">topk(5, avg(rate(cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;, pod=~&quot;$pod&quot;}[5m])) by (pod, map_name, operation))</code></pre><p id="23bb8b2c-1c23-80cc-b0a4-cf05cb012aa8" class="">
</p></li></ul><ul id="23bb8b2c-1c23-80ba-9aa5-d5109d891710" class="bulleted-list"><li style="list-style-type:disc"><strong>프로메테우스에서</strong> 쿼리 해보면서 이해하기 - <a href="https://docs.cilium.io/en/stable/observability/metrics/">Docs</a><ul id="23bb8b2c-1c23-809b-af20-c1e0dc6259b9" class="bulleted-list"><li style="list-style-type:circle"><strong>cilium_bpf_map_ops_total</strong> : Number of <strong>eBPF map operations performed</strong>. ⇒ 수행된 eBPF Map 작업 수<ul id="23bb8b2c-1c23-80df-b823-f702afbd8e23" class="bulleted-list"><li style="list-style-type:square"><code>mapName</code> is deprecated and will be removed in 1.10. Use <code>map_name</code> instead.</li></ul></li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23bb8b2c-1c23-80dd-a2b1-c8b7e2be5d1d" class="code"><code class="language-Shell">#
cilium_bpf_map_ops_total
cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;}
cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;, pod=&quot;cilium-66scd&quot;}

# 최근 5분 간의 데이터로 증가율 계산
rate(cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;}[5m]) # Graph 확인

# 여러 시계열(metric series)의 값의 평균
avg(rate(cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;}[5m]))

# 집계 함수(예: sum, avg, max, rate)와 함께 사용하여 어떤 레이블(label)을 기준으로 그룹화할지를 지정하는 그룹핑(grouping) 
avg(rate(cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;}[5m])) by (pod)
avg(rate(cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;}[5m])) by (pod, map_name)
avg(rate(cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;}[5m])) by (pod, map_name, operation) # Graph 확인

# 시계열 중에서 가장 큰 k개를 선택
topk(5, avg(rate(cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;}[5m]))) by (pod, map_name, operation)
topk(5, avg(rate(cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;, pod=~&quot;cilium-66scd&quot;}[5m])) by (pod, map_name, operation))</code></pre><figure id="23cb8b2c-1c23-80eb-b1ca-ee5f918fa296" class="image"><a href="images/image%204.png"><img style="width:1008px" src="images/image%204.png"/></a></figure><p id="23cb8b2c-1c23-80c8-b841-c7d567086712" class="">→ avg(rate(cilium_bpf_map_ops_total{k8s_app=&quot;cilium&quot;}[5m])) by (pod, map_name, operation)<div class="indented"><ul id="23cb8b2c-1c23-80d3-8f69-cf7e2eb354bd" class="bulleted-list"><li style="list-style-type:disc">최근 07:45 ~ 07:50 사이에 eBPF Map 작업 수가 많이 수행된 이유는 promehtues, grafana 배포함에 따라 eBPF Map작업이 새롭게 많이 수행됬기 때문!</li></ul></div></p><p id="23cb8b2c-1c23-806a-89c4-df5196e06619" class="">
</p></li></ul><ul id="23bb8b2c-1c23-80ae-99bf-e2776cdbfdca" class="bulleted-list"><li style="list-style-type:disc"><strong>그라파나</strong> 해당 대시보드 편집 → Variables<ul id="23bb8b2c-1c23-8060-b87f-ec02e6c88c75" class="bulleted-list"><li style="list-style-type:circle">pod=~&quot;<code>$pod</code>&quot; 변수 사용</li></ul><figure id="23cb8b2c-1c23-8059-b055-c734b1e5ebd3" class="image"><a href="images/image%205.png"><img style="width:480px" src="images/image%205.png"/></a></figure><figure id="23bb8b2c-1c23-807c-bd1a-ddbeb5dfb70a" class="image"><a href="images/CleanShot_2025-07-20_at_15.07.33.png"><img style="width:864px" src="images/CleanShot_2025-07-20_at_15.07.33.png"/></a></figure></li></ul><p id="23bb8b2c-1c23-80e4-971a-ccbb0099afa1" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-8076-b1be-c1f2227467ca" class="bulleted-list"><li style="list-style-type:circle"><strong>Cilium Operator 대시보드</strong> : IPAM</li></ul><ul id="23bb8b2c-1c23-80fd-ba82-e339f6934e16" class="bulleted-list"><li style="list-style-type:circle"><strong>Hubble 대시보드</strong> : General Processing, Network, Network Policy, HTTP, DNS<figure id="23bb8b2c-1c23-8033-97f4-d449f8040290" class="image"><a href="images/CleanShot_2025-07-20_at_15.11.50.png"><img style="width:912px" src="images/CleanShot_2025-07-20_at_15.11.50.png"/></a></figure><p id="23bb8b2c-1c23-80b1-a976-ca87cedcda67" class="">
</p></li></ul><ul id="23bb8b2c-1c23-8011-be6b-f291d1a4deea" class="bulleted-list"><li style="list-style-type:circle"><strong>Hubble L7 HTTP Metrics by Workload 대시보드</strong> : General, Requests by Source, Requests by Destination</li></ul></li></ul><p id="23bb8b2c-1c23-8087-8939-d59023e904e9" class="">
</p></details></li></ul><ul id="23bb8b2c-1c23-80d4-889e-f777b8d1c6e5" class="bulleted-list"><li style="list-style-type:disc"><code>도전과제3</code> <strong>프로메테우스-스택</strong>을 설치하고 ‘Cilium, Hubble, Cilium Operator’ 수집 설정 후, 그라파나 대시보드 검색 후 추가해보기.</li></ul></li></ol><p id="23cb8b2c-1c23-802b-b8ec-ee363eac1f0d" class="">
</p><ol type="1" id="23cb8b2c-1c23-80d1-89bd-d109091f3a0d" class="numbered-list" start="3"><li><strong>Monitoring &amp; Metrics</strong></li></ol><ul id="23cb8b2c-1c23-80d7-960f-d428a5553bde" class="bulleted-list"><li style="list-style-type:disc">eCHO Episode 170: Cilium <strong>Metrics</strong> Review - <a href="https://www.youtube.com/watch?v=aOm1YUO2Vmo">Link</a></li></ul><ul id="23cb8b2c-1c23-80cd-be5c-c7f489942631" class="toggle"><li><details open=""><summary><strong>3.1. Cilium Metrics</strong> 설정 및 수집 방법 - <a href="https://docs.cilium.io/en/stable/observability/metrics/#cilium-metrics">Docs</a></summary><ul id="23cb8b2c-1c23-8053-8e2a-f94c13207256" class="bulleted-list"><li style="list-style-type:disc">Cilium metrics은 Cilium 자체의 상태, 즉 Cilium Agent, Cilium envoy, Cilium operator 프로세스에 대한 인사이트를 제공합니다. </li></ul><ul id="23cb8b2c-1c23-80b1-98ef-ec13db575f37" class="bulleted-list"><li style="list-style-type:disc">프로메테우스 메트릭이 활성화된 Cilium을 실행하려면 <code>prometheus.enabled=true</code> Helm 값 집합을 사용하여 Cilium을 배포하세요.</li></ul><ul id="23cb8b2c-1c23-8038-969a-d2f09f4a513d" class="bulleted-list"><li style="list-style-type:disc">Cilium metrics are exported under the <code>cilium_</code> Prometheus namespace. </li></ul><ul id="23cb8b2c-1c23-80b7-82ea-db0d0b63996f" class="bulleted-list"><li style="list-style-type:disc">Envoy metrics are exported under the <code>envoy_</code> Prometheus namespace, of which the Cilium-defined metrics are exported under the <code>envoy_cilium_</code> namespace. </li></ul><ul id="23cb8b2c-1c23-8059-a2b4-d0e8398f989c" class="bulleted-list"><li style="list-style-type:disc">Kubernetes에서 실행 및 수집할 때 포드 이름과 네임스페이스로 태그가 지정됩니다.</li></ul><ul id="23cb8b2c-1c23-804d-bcdd-c7257063a658" class="bulleted-list"><li style="list-style-type:disc"><strong>설정 → 이미 되어 있음</strong><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23cb8b2c-1c23-80e6-bf2f-e77c7ea5901b" class="code"><code class="language-Bash">#
helm install cilium cilium/cilium --version 1.17.6 \
  --namespace kube-system \
  --set prometheus.enabled=true \
  --set operator.prometheus.enabled=true

# The ports can be configured via prometheus.port, envoy.prometheus.port, or operator.prometheus.port respectively.
--set prometheus.port
--set envoy.prometheus.port
--set operator.prometheus.port
...</code></pre><p id="23cb8b2c-1c23-80a8-9e6b-e07a2601719a" class="">
</p></li></ul><ul id="23cb8b2c-1c23-8066-a31d-dfc567b824d1" class="bulleted-list"><li style="list-style-type:disc">메트릭이 활성화되면 모든 Cilium 구성 요소에는 다음과 같은 주석이 표시됩니다. 주석은 Prometheus에게 메트릭을 스크랩할지 여부를 알리는 데 사용합니다.<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23cb8b2c-1c23-8010-ae87-cdcef4c828f4" class="code"><code class="language-Shell"># cilium-agent 데몬셋 파드
# ds이므로 각 node의 9962 port가 open되어있음
# anntation에 아래의 promehtues.io/port, prometheus.io/scrape가 설정되어있다.
kubectl describe pod -n kube-system -l k8s-app=cilium | grep prometheus
                      prometheus.io/port: 9962
                      prometheus.io/scrape: true
                      prometheus.io/port: 9962
                      prometheus.io/scrape: true
                      prometheus.io/port: 9962
                      prometheus.io/scrape: true

curl 192.168.10.100:9962/metrics
curl 192.168.10.101:9962/metrics
curl 192.168.10.102:9962/metrics

# cilium-operator 디플로이먼트 파드
# cilium-operator는 k8s-ctr에 하나의 pod가 배포되어있다.
# anntation에 아래의 promehtues.io/port, prometheus.io/scrape가 설정되어있다.
kubectl describe pod -n kube-system -l name=cilium-operator | grep prometheus
Annotations:          prometheus.io/port: 9963
                      prometheus.io/scrape: true

curl 192.168.10.100:9963/metrics
</code></pre><ul id="23cb8b2c-1c23-808f-a2f8-c2d4eae7d2ee" class="bulleted-list"><li style="list-style-type:circle">This additional headless service in addition to the other Cilium components is needed as each component can only have one Prometheus scrape and port annotation.</li></ul><ul id="23cb8b2c-1c23-805b-b8af-c8a7f9b7fd0b" class="bulleted-list"><li style="list-style-type:circle">pod level에 annotaion이 설정되어있으므로 targets &gt; kubernetes-pods에 보면 cilium, cilium-operator target이 등록된걸 볼 수 있음(<a href="http://192.168.10.100:30001/targets?search=#pool-kubernetes-pods">http://192.168.10.100:30001/targets?search=#pool-kubernetes-pods</a>)</li></ul><figure id="23cb8b2c-1c23-8087-b72e-f462030d9346" class="image"><a href="images/CleanShot_2025-07-20_at_16.29.10.png"><img style="width:768px" src="images/CleanShot_2025-07-20_at_16.29.10.png"/></a></figure><p id="23cb8b2c-1c23-806e-84f7-f87eb0aefe49" class="">
</p></li></ul><ul id="23cb8b2c-1c23-80cb-988e-c72b35198116" class="bulleted-list"><li style="list-style-type:disc">Prometheus will pick up the Cilium and Envoy metrics automatically if the following option is set in the <code>scrape_configs</code> section:<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23cb8b2c-1c23-802e-9208-e491a8a1224e" class="code"><code class="language-Bash">#
kc describe cm -n cilium-monitoring prometheus
...
# https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L156
  - job_name: &#x27;kubernetes-pods&#x27;
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: (.+):(?:\d+);(\d+)
        replacement: ${1}:${2}
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: pod
      - source_labels: [__meta_kubernetes_pod_container_port_number]
        action: keep
        regex: \d+</code></pre></li></ul><p id="23cb8b2c-1c23-80f5-ac0e-c1fd467927ff" class="">
</p></details></li></ul><ul id="23cb8b2c-1c23-80d8-9c4c-da732644a8cd" class="toggle"><li><details open=""><summary><mark class="highlight-blue"><strong>3.2. Hubble Metrics</strong></mark> 설정 및 수집 방법 - <a href="https://docs.cilium.io/en/stable/observability/metrics/#hubble-metrics">Docs</a></summary><ul id="23cb8b2c-1c23-80cc-89ea-d318b55cc4d2" class="bulleted-list"><li style="list-style-type:disc">Cilium 메트릭은 Cilium 상태 자체를 모니터링할 수 있게 해주지만, <strong>Hubble</strong> 메트릭은 Cilium이 관리하는 쿠버네티스 <strong>포드의 네트워크 동작을 연결 및 보안</strong>과 관련하여 <strong>모니터링</strong>할 수 있게 해줍니다.</li></ul><ul id="23cb8b2c-1c23-80c1-8bff-f868d199b1eb" class="bulleted-list"><li style="list-style-type:disc"><strong>설정 → 이미 되어 있음</strong><ul id="23cb8b2c-1c23-80d3-9e7c-ca4726f21a31" class="bulleted-list"><li style="list-style-type:circle">Some of the metrics can also be configured with additional options. See the <a href="https://docs.cilium.io/en/stable/observability/metrics/#hubble-exported-metrics">Hubble exported metrics</a> section for the full list of available metrics and their options.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23cb8b2c-1c23-805d-b14b-dfbfc8414b05" class="code"><code class="language-Bash">#
helm install cilium cilium/cilium --version 1.17.6 \
  --namespace kube-system \
  --set prometheus.enabled=true \
  --set operator.prometheus.enabled=true \
  --set hubble.enabled=true \
  --set hubble.metrics.enableOpenMetrics=true \
  --set hubble.metrics.enabled=&quot;{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\,source_namespace\,source_workload\,destination_ip\,destination_namespace\,destination_workload\,traffic_direction}&quot;
  --set hubble.metrics.port
 </code></pre><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="23cb8b2c-1c23-80fa-a1e5-e7dc3014a77f"><div style="font-size:1.5em"><span class="icon">👉🏻</span></div><div style="width:100%"><p id="23cb8b2c-1c23-8033-b88d-c389addfa9b2" class=""><strong>L7 metrics</strong> such as <strong>HTTP</strong>, are only <strong>emitted</strong> for pods that enable <a href="https://docs.cilium.io/en/stable/observability/visibility/#proxy-visibility">Layer 7 Protocol Visibility</a>. <em><mark class="highlight-gray">⇒ L7 메트릭은 L7 가시성 활성화 필요!</mark></em></p></div></figure><p id="23cb8b2c-1c23-809c-b70b-c7aee45b98bd" class="">
</p></li></ul><ul id="23cb8b2c-1c23-8066-b1ce-e74763a164c5" class="bulleted-list"><li style="list-style-type:disc">When deployed with a non-empty <code>hubble.metrics.enabled</code> Helm value, the Cilium chart will create a Kubernetes headless service named <code>hubble-metrics</code> with the <code>prometheus.io/scrape:&#x27;true&#x27;</code> annotation set:<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23cb8b2c-1c23-80cd-b186-fc7f2e784f7f" class="code"><code class="language-Shell"># hubble-metrics 헤드리스 서비스 정보 확인
kubectl get svc -n kube-system hubble-metrics
apiVersion: v1
kind: Service
metadata:
  annotations:
...
    prometheus.io/scrape: &quot;true&quot;
...
spec:
  clusterIP: None
  clusterIPs:
  - None
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: hubble-metrics
    port: 9965
    protocol: TCP
    targetPort: hubble-metrics
  selector:
    k8s-app: cilium
  sessionAffinity: None
  type: ClusterIP
  
kc describe svc -n kube-system hubble-metrics
...
                          prometheus.io/port: 9965
                          prometheus.io/scrape: true
...
Endpoints:                192.168.10.101:9965,192.168.10.100:9965,192.168.10.102:9965
...

curl 192.168.10.100:9965/metrics


#
kc describe cm -n cilium-monitoring prometheus
  # https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L79
  - job_name: &#x27;kubernetes-endpoints&#x27;
    kubernetes_sd_configs:
      - role: endpoints
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_k8s_app]
        action: keep
        regex: cilium
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+)(?::\d+);(\d+)
        replacement: $1:$2
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: namespace
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: service</code></pre><figure id="23cb8b2c-1c23-8056-956f-f11aa5ab7bb8" class="image"><a href="images/CleanShot_2025-07-20_at_16.29.40.png"><img style="width:912px" src="images/CleanShot_2025-07-20_at_16.29.40.png"/></a></figure></li></ul><p id="23cb8b2c-1c23-80c1-9876-f74c9590b617" class="">
</p></details></li></ul><ul id="23cb8b2c-1c23-8016-9ef2-d599c8258d23" class="toggle"><li><details open=""><summary><strong>3.3. OpenMetrics - </strong><strong><a href="https://docs.cilium.io/en/stable/observability/metrics/#openmetrics">Docs</a></strong> , OpenMetrics - <a href="https://openmetrics.io/">Home</a> , <a href="https://github.com/prometheus/OpenMetrics">Github</a> , <a href="https://prometheus.io/docs/specs/om/open_metrics_spec/">Spec</a> , <a href="https://meetup.nhncloud.com/posts/284">https://meetup.nhncloud.com/posts/284</a></summary><ul id="23cb8b2c-1c23-80b9-81ca-c233609833fd" class="bulleted-list"><li style="list-style-type:disc"><code>hubble.metrics.enableOpenMetrics=true</code>를 설정하여 OpenMetrics에 opt-in할 수 있습니다.</li></ul><ul id="23cb8b2c-1c23-8070-85e7-e502f7c7bb07" class="bulleted-list"><li style="list-style-type:disc">OpenMetrics를 활성화하면 클라이언트가 명시적으로 요청할 때 Hubble metrics endpoint가 OpenMetrics 형식으로 메트릭 내보내기를 지원하도록 구성됩니다.</li></ul><ul id="23cb8b2c-1c23-8061-8f2e-f1a888cadfdc" class="bulleted-list"><li style="list-style-type:disc">OpenMetrics를 사용하면 Export된 메트릭에 트레이스 ID를 삽입하여 메트릭을 트레이스와 연결할 수 있는 Examplears와 같은 추가 기능을 지원합니다.</li></ul><ul id="23cb8b2c-1c23-80eb-8961-cc87c48e41c1" class="bulleted-list"><li style="list-style-type:disc">Prometheus는 OpenMetrics를 활용하도록 구성해야 하며, Exemplar storage이 활성화된 경우에만 예제를 스크랩합니다. - <a href="https://prometheus.io/docs/prometheus/latest/feature_flags/#exemplars-storage">Docs</a></li></ul><ul id="23cb8b2c-1c23-806c-aa4d-ef62ff8bdcec" class="bulleted-list"><li style="list-style-type:disc">OpenMetrics는 메트릭 이름과 레이블에 몇 가지 추가 요구 사항을 부과하므로 현재 이 기능은 opt-in 상태입니다. 그러나 우리는 모든 허블 메트릭이 OpenMetrics 요구 사항을 준수한다고 믿습니다.</li></ul><p id="23cb8b2c-1c23-8036-9b73-f0133dbec194" class="">
</p></details></li></ul><ul id="23cb8b2c-1c23-8008-b2d5-e9fea7f9b0b2" class="bulleted-list"><li style="list-style-type:disc">Cluster Mesh API Server Metrics : Skip - <a href="https://docs.cilium.io/en/stable/observability/metrics/#cluster-mesh-api-server-metrics">Docs</a></li></ul><ul id="23cb8b2c-1c23-8094-a07e-d87e506fc0f0" class="toggle"><li><details open=""><summary>3.4. Metrics Reference : 개별 메트릭에 대한 설명 - <a href="https://docs.cilium.io/en/stable/observability/metrics/#metrics-reference">Docs</a></summary><ul id="23cb8b2c-1c23-807c-8136-f2c5a4cb2c4a" class="bulleted-list"><li style="list-style-type:disc">cilium-agent : - <a href="https://docs.cilium.io/en/stable/observability/metrics/#cilium-agent">Link</a><ul id="23cb8b2c-1c23-8000-983e-f06d60afba11" class="bulleted-list"><li style="list-style-type:circle">Feature Metrics : Advanced Connectivity and Load Balancing, Control Plane, Datapath, Network Policies</li></ul><ul id="23cb8b2c-1c23-80e1-b5c8-cb376429a25c" class="bulleted-list"><li style="list-style-type:circle">Exported Metrics : Endpoint, Service, Cluster health, Node Connectivity, Clustermesh, Datapath, IPSec, eBPF, Drops/Forwards(L3/L4)…</li></ul></li></ul><ul id="23cb8b2c-1c23-8056-8e02-ebef8a8214c2" class="bulleted-list"><li style="list-style-type:disc">cilium-operator : - <a href="https://docs.cilium.io/en/stable/observability/metrics/#cilium-operator">Link</a> <ul id="23cb8b2c-1c23-80fd-94f6-cd3d50c627b3" class="bulleted-list"><li style="list-style-type:circle">Feature Metrics : Advanced Connectivity and Load Balancing</li></ul><ul id="23cb8b2c-1c23-807f-aebb-c87ee010c538" class="bulleted-list"><li style="list-style-type:circle">Exported Metrics : BGP Control Operator, IPAM, LB-IPAM, Controllers, CiliumEndpointSlices, Unmanaged Pods..</li></ul></li></ul><ul id="23cb8b2c-1c23-806a-b354-ef86c02a57b4" class="bulleted-list"><li style="list-style-type:disc">Hubble : 다른 메트릭과 다르게 semicolon-separated options per metric 제공 - <a href="https://docs.cilium.io/en/stable/observability/metrics/#hubble">Link</a><ul id="23cb8b2c-1c23-80ee-b5d9-eec1c4c6fc5e" class="bulleted-list"><li style="list-style-type:circle">예시) <code>--hubble-metrics=&quot;dns:query;ignoreAAAA http:destinationContext=workload-name&quot;</code> will enable the <code>dns</code> metric with the <code>query</code> and <code>ignoreAAAA</code> options, and the <code>http</code> metric with the <code>destinationContext=workload-name</code> option.</li></ul><ul id="23cb8b2c-1c23-803f-8ed0-c6a70fcf4a4c" class="bulleted-list"><li style="list-style-type:circle"><strong>Context Options</strong><ul id="23cb8b2c-1c23-8061-b9a8-e5f512394723" class="bulleted-list"><li style="list-style-type:square"><code>sourceContext</code> - Configures the <code>source</code> label on metrics for both egress and ingress traffic.</li></ul><ul id="23cb8b2c-1c23-80bb-958d-e650a223dc0a" class="bulleted-list"><li style="list-style-type:square"><code>sourceEgressContext</code> - Configures the <code>source</code> label on metrics for egress traffic (takes precedence over <code>sourceContext</code>).</li></ul><ul id="23cb8b2c-1c23-8027-b56b-c739fe39afcc" class="bulleted-list"><li style="list-style-type:square"><code>sourceIngressContext</code> - Configures the <code>source</code> label on metrics for ingress traffic (takes precedence over <code>sourceContext</code>).</li></ul><ul id="23cb8b2c-1c23-8078-9931-d4236664ba2b" class="bulleted-list"><li style="list-style-type:square"><code>destinationContext</code> - Configures the <code>destination</code> label on metrics for both egress and ingress traffic.</li></ul><ul id="23cb8b2c-1c23-8098-9f8d-ffb13004ef8e" class="bulleted-list"><li style="list-style-type:square"><code>destinationEgressContext</code> - Configures the <code>destination</code> label on metrics for egress traffic (takes precedence over <code>destinationContext</code>).</li></ul><ul id="23cb8b2c-1c23-8055-bc0a-e68f3d90d403" class="bulleted-list"><li style="list-style-type:square"><code>destinationIngressContext</code> - Configures the <code>destination</code> label on metrics for ingress traffic (takes precedence over <code>destinationContext</code>).</li></ul><ul id="23cb8b2c-1c23-80b1-af8f-ce0d65957473" class="bulleted-list"><li style="list-style-type:square"><code>labelsContext</code> - Configures a list of labels to be enabled on metrics.</li></ul></li></ul><ul id="23cb8b2c-1c23-800d-be76-f2b5d72e6b5d" class="bulleted-list"><li style="list-style-type:circle">Most Hubble metrics can be configured to add the source and/or destination context as a label using the <code>sourceContext</code> and <code>destinationContext</code> options. The possible values are:<table id="23cb8b2c-1c23-80d8-b3bc-f908ceb17496" class="simple-table"><thead class="simple-table-header"><tr id="23cb8b2c-1c23-806b-a785-ff15cdd9849d"><th id="U\?Z" class="simple-table-header-color simple-table-header" style="width:160.3125px"><strong>Option Value</strong></th><th id="ax_C" class="simple-table-header-color simple-table-header" style="width:788px"><strong>Description</strong></th></tr></thead><tbody><tr id="23cb8b2c-1c23-8065-8f42-d64d6245fbc4"><td id="U\?Z" class="" style="width:160.3125px"><code>identity</code></td><td id="ax_C" class="" style="width:788px">All Cilium security identity labels</td></tr><tr id="23cb8b2c-1c23-805f-8903-eee4006363a6"><td id="U\?Z" class="" style="width:160.3125px"><code>namespace</code></td><td id="ax_C" class="" style="width:788px">Kubernetes namespace name</td></tr><tr id="23cb8b2c-1c23-80e5-8d2c-d9757c9ddb5b"><td id="U\?Z" class="" style="width:160.3125px"><code>pod</code></td><td id="ax_C" class="" style="width:788px">Kubernetes pod name and namespace name in the form of <code>namespace/pod</code>.</td></tr><tr id="23cb8b2c-1c23-80e2-8cc4-c89d5036ead9"><td id="U\?Z" class="" style="width:160.3125px"><code>pod-name</code></td><td id="ax_C" class="" style="width:788px">Kubernetes pod name.</td></tr><tr id="23cb8b2c-1c23-8064-ad0a-f3fb563a06af"><td id="U\?Z" class="" style="width:160.3125px"><code>dns</code></td><td id="ax_C" class="" style="width:788px">All known DNS names of the source or destination (comma-separated)</td></tr><tr id="23cb8b2c-1c23-80d2-816a-f2d1425a3265"><td id="U\?Z" class="" style="width:160.3125px"><code>ip</code></td><td id="ax_C" class="" style="width:788px">The IPv4 or IPv6 address</td></tr><tr id="23cb8b2c-1c23-80d2-9e1b-f34cab1e8cd7"><td id="U\?Z" class="" style="width:160.3125px"><code>reserved-identity</code></td><td id="ax_C" class="" style="width:788px">Reserved identity label.</td></tr><tr id="23cb8b2c-1c23-8081-929e-ff02ecd88597"><td id="U\?Z" class="" style="width:160.3125px"><code>workload</code></td><td id="ax_C" class="" style="width:788px">Kubernetes pod’s workload name and namespace in the form of <code>namespace/workload-name</code>.</td></tr><tr id="23cb8b2c-1c23-80fe-a2d7-ec29c4e886f8"><td id="U\?Z" class="" style="width:160.3125px"><code>workload-name</code></td><td id="ax_C" class="" style="width:788px">Kubernetes pod’s workload name (workloads are: Deployment, Statefulset, Daemonset, ReplicationController, CronJob, Job, DeploymentConfig (OpenShift), etc).</td></tr><tr id="23cb8b2c-1c23-8033-935b-e372aefe5136"><td id="U\?Z" class="" style="width:160.3125px"><code>app</code></td><td id="ax_C" class="" style="width:788px">Kubernetes pod’s app name, derived from pod labels (<code>app.kubernetes.io/name</code>, <code>k8s-app</code>, or <code>app</code>).</td></tr></tbody></table></li></ul><ul id="23cb8b2c-1c23-80de-af4d-f6350ef3f50f" class="bulleted-list"><li style="list-style-type:circle"><strong>나머지는 공식문서 내용 확인 할 것!</strong></li></ul></li></ul><p id="23cb8b2c-1c23-8034-a9f5-d42f974847ae" class="">
</p></details></li></ul><ul id="23cb8b2c-1c23-80e4-aeb8-f1c048112c68" class="bulleted-list"><li style="list-style-type:disc"><code>도전과제4</code> 공식 문서 ‘Scalability report’ 에 부하 증가 시나리오를 참고하여 부하 발생 후 그라파나 메트픽 관찰 후 최적화 시도 - <a href="https://docs.cilium.io/en/stable/operations/performance/scalability/report/">Docs</a></li></ul><p id="23cb8b2c-1c23-808e-bd4c-e4335b6d21f1" class="">
</p><ol type="1" id="23cb8b2c-1c23-809d-8680-fcf6247afd50" class="numbered-list" start="4"><li> <strong>Layer 7 Protocol Visibility</strong></li></ol><ul id="23cb8b2c-1c23-80a0-9441-de093273626d" class="toggle"><li><details open=""><summary>4.1. 소개</summary><ul id="23cb8b2c-1c23-8060-97ad-fd952f1462ad" class="bulleted-list"><li style="list-style-type:disc"><strong>Monitoring Datapath Stat</strong>e는 datapath state에 대한 성찰을 제공하지만, 기본적으로 L3/L4 패킷 이벤트에 대한 가시성만 제공합니다.</li></ul><ul id="23cb8b2c-1c23-80aa-bc70-ee8edf7dfbd6" class="bulleted-list"><li style="list-style-type:disc">L7 프로토콜 가시성을 원한다면 <strong>L7 Cilium Network Policies </strong>을 사용할 수 있습니다(레이어 7 예제 참조).</li></ul><ul id="23cb8b2c-1c23-80c8-9fbc-c13678015096" class="bulleted-list"><li style="list-style-type:disc">L7 트래픽에 대한 가시성을 활성화하려면 L7 규칙을 지정하는 CiliumNetworkPolicy를 만드세요.</li></ul><ul id="23cb8b2c-1c23-8017-9563-e4db18720d23" class="bulleted-list"><li style="list-style-type:disc"><strong>CiliumNetworkPolicy</strong>에서 L7 규칙과 일치하는 트래픽 흐름이 Cilium에 표시되므로 최종 사용자에게 노출될 수 있습니다.</li></ul><ul id="23cb8b2c-1c23-80d9-816d-c71c8ae6c5d9" class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-red"><strong>L7 네트워크 정책</strong></mark>은 <mark class="highlight-red"><strong>가시성</strong></mark>을 가능하게 할 뿐만 아니라 포드에 들어오고 나가는 <mark class="highlight-red"><strong>트래픽을 제한</strong></mark>한다는 점을 기억하는 것이 중요합니다.</li></ul><p id="23cb8b2c-1c23-80e4-b89e-fc936e7c6b4f" class="">
</p></details></li></ul><ul id="23cb8b2c-1c23-8019-8f62-c0575cbe63e4" class="toggle"><li><details open=""><summary>4.2. 실습</summary><ul id="23cb8b2c-1c23-8080-ac85-d4f98259ea85" class="bulleted-list"><li style="list-style-type:disc">다음 예제는 DNS(TCP/UDP/53) 및 HTTP(포트 TCP/80 및 TCP/8080) 트래픽을 기본 네임스페이스 내에서 표시할 수 있도록 두 가지 L7 규칙을 지정합니다. </li></ul><ul id="23cb8b2c-1c23-80f8-8c0b-eae74a3b7395" class="bulleted-list"><li style="list-style-type:disc">하나는 <strong>DNS 규칙</strong>이고 다른 하나는 <strong>HTTP 규칙</strong>입니다. 한 출력 통신을 제한하고 일치하지 않는 모든 것을 삭제합니다. </li></ul><ul id="23cb8b2c-1c23-80c9-96be-e5ea2a37f11b" class="bulleted-list"><li style="list-style-type:disc">규칙의 L7 일치 조건이 생략되거나 와일드카드 처리되어 각 규칙의 L4 섹션과 일치하는 모든 요청이 허용됩니다:</li></ul><ul id="23cb8b2c-1c23-8073-8940-f4d2bf132eab" class="bulleted-list"><li style="list-style-type:disc">L7 네트워크 정책(가시성) 생성 및 확인<ul id="23cb8b2c-1c23-8046-8682-c5c6033eaf3f" class="bulleted-list"><li style="list-style-type:circle">참고 : DNS visibility is available on egress only</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23cb8b2c-1c23-8052-bbbb-d5c9d822657f" class="code"><code class="language-Shell"># 반복 접속 해둔 상태
kubectl exec -it curl-pod -- sh -c &#x27;while true; do curl -s webpod | grep Hostname; sleep 1; done&#x27;


# default 네임스페이스에 있는 Pod들의 egress(출방향) 트래픽을 제어하며, L7 HTTP 및 DNS 트래픽에 대한 가시성과 제어를 설정
## method/path 기반 필터링은 안 하지만, HTTP 요청 정보는 Envoy를 통해 기록/관찰됨
## cilium-envoy를 경유하게 됨 (DNS + HTTP 모두 L7 처리 대상)
## 이 정책이 적용되면, 명시된 egress 외의 모든 egress 트래픽은 차단됩니다 (Cilium 정책은 default-deny 모델임)
cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;l7-visibility&quot;
spec:
  endpointSelector:
    matchLabels:
      &quot;k8s:io.kubernetes.pod.namespace&quot;: default  # default 네임스페이스 안의 모든 Pod에 대해 egress 정책이 적용
  egress:
  - toPorts:
    - ports:
      - port: &quot;53&quot;
        protocol: ANY  # TCP, UDP 둘 다 허용
      rules:
        dns:
        - matchPattern: &quot;*&quot;  # 모든 도메인 조회 허용, L7 가시성 활성화
  - toEndpoints:
    - matchLabels:
        &quot;k8s:io.kubernetes.pod.namespace&quot;: default
    toPorts:
    - ports:
      - port: &quot;80&quot;  # default 다른 파드의 HTTP TCP 80 요청 허용
        protocol: TCP
      - port: &quot;8080&quot;  # default 다른 파드의 HTTP TCP 8080 요청 허용
        protocol: TCP
      rules:
        http: [{}]  # 모든 HTTP 요청을 허용, L7 가시성 활성화
EOF

kubectl get cnp -o yaml


kubectl get po -o wide
NAME                      READY   STATUS    RESTARTS      AGE   IP             NODE      NOMINATED NODE   READINESS GATES
curl-pod                  1/1     Running   1 (86m ago)   17h   172.20.0.49    k8s-ctr   &lt;none&gt;           &lt;none&gt;
webpod-697b545f57-4p672   1/1     Running   1 (86m ago)   17h   172.20.2.129   k8s-w2    &lt;none&gt;           &lt;none&gt;
webpod-697b545f57-8cnf7   1/1     Running   1 (86m ago)   17h   172.20.1.43    k8s-w1    &lt;none&gt;           &lt;none&gt;

# 호출 확인 : cilium-envoy 경유 확인
# clilium-envoy는 remote ip(client ip)를 x-fowarded-for에 담지 않고 그대로 RemoteAddr에 담는다. 
kubectl exec -it curl-pod -- curl -s webpod
Hostname: webpod-697b545f57-4p672
IP: 127.0.0.1
IP: ::1
IP: 172.20.2.129
IP: fe80::88c0:1cff:fe87:85cf
RemoteAddr: 172.20.0.49:51948 # 해당 IP는 curl-pod 의 IP로 cilium-envoy IP로 SNAT 되지 않았음!
GET / HTTP/1.1
Host: webpod
User-Agent: curl/8.14.1
Accept: */*
X-Envoy-Expected-Rq-Timeout-Ms: 3600000 # cilium-envoy 경유 확인
X-Envoy-Internal: true
X-Forwarded-Proto: http
X-Request-Id: 84eef926-0ba1-4cf6-9be7-5493a105fee6


# hubble-relay port확인
ss -tnlp | grep 4245

# 4245 open 안되어있을경우
cilium hubble port-forward&amp;
Hubble Relay is available at 127.0.0.1:4245

# 가시성 확인
# http, dns query에 대한 가시성을 확인 할 수 있음
hubble observe -f -t l7 -o compact
Jul 26 09:49:42.051: default/curl-pod:34814 (ID:1294) -&gt; kube-system/coredns-674b8bbfcf-pxmpk:53 (ID:18848) dns-request proxy FORWARDED (DNS Query webpod.default.svc.cluster.local. AAAA)
Jul 26 09:49:42.051: default/curl-pod:34814 (ID:1294) -&gt; kube-system/coredns-674b8bbfcf-pxmpk:53 (ID:18848) dns-request proxy FORWARDED (DNS Query webpod.default.svc.cluster.local. A)
Jul 26 09:49:42.051: default/curl-pod:34814 (ID:1294) &lt;- kube-system/coredns-674b8bbfcf-pxmpk:53 (ID:18848) dns-response proxy FORWARDED (DNS Answer  TTL: 4294967295 (Proxy webpod.default.svc.cluster.local. AAAA))
Jul 26 09:49:42.052: default/curl-pod:34814 (ID:1294) &lt;- kube-system/coredns-674b8bbfcf-pxmpk:53 (ID:18848) dns-response proxy FORWARDED (DNS Answer &quot;10.96.210.54&quot; TTL: 30 (Proxy webpod.default.svc.cluster.local. A))
Jul 26 09:49:42.053: default/curl-pod:59328 (ID:1294) -&gt; default/webpod-697b545f57-4p672:80 (ID:12737) http-request FORWARDED (HTTP/1.1 GET http://webpod/)
Jul 26 09:49:42.056: default/curl-pod:59328 (ID:1294) &lt;- default/webpod-697b545f57-4p672:80 (ID:12737) http-response FORWARDED (HTTP/1.1 200 2ms (GET http://webpod/))
...
혹은 cilium nonitor ~</code></pre><p id="23cb8b2c-1c23-80aa-a67b-dd7f8f223f44" class="">
</p></li></ul><ul id="23cb8b2c-1c23-8038-97d5-c5fb21fcd1e7" class="bulleted-list"><li style="list-style-type:disc">그라파나 HTTP L7 HTTP Metrics by Workload<figure id="23cb8b2c-1c23-80a6-bbc8-c031abb645aa" class="image"><a href="images/CleanShot_2025-07-20_at_17.47.46.png"><img style="width:1152px" src="images/CleanShot_2025-07-20_at_17.47.46.png"/></a></figure><p id="23cb8b2c-1c23-80fe-a608-de77b8f5dd7a" class="">
</p></li></ul><ul id="23cb8b2c-1c23-8002-b8ad-f3347ad6d849" class="bulleted-list"><li style="list-style-type:disc">프로메테우스 <code>rate(hubble_http_requests_total[5m])</code><figure id="23cb8b2c-1c23-8066-8ba0-ffecdef9d029" class="image"><a href="images/CleanShot_2025-07-20_at_17.52.52.png"><img style="width:912px" src="images/CleanShot_2025-07-20_at_17.52.52.png"/></a></figure></li></ul><p id="23cb8b2c-1c23-80a3-bbd5-ccc4b7c70d7c" class="">
</p></details></li></ul><ul id="23cb8b2c-1c23-8074-a13f-d216c737b946" class="toggle"><li><details open=""><summary>4.3. Security Implications &amp; 실습 - <a href="https://docs.cilium.io/en/stable/observability/visibility/#security-implications">Docs</a></summary><ul id="23cb8b2c-1c23-80c4-a810-e443a98cf18a" class="bulleted-list"><li style="list-style-type:disc">레이어 7 트래픽 모니터링에는 <mark class="highlight-red"><strong>사용자 이름, 비밀번호, 쿼리 매개변수, API 키</strong></mark> 등 잠재적으로 민감한 정보를 처리하기 위한 보안 고려 사항이 포함됩니다.</li></ul><ul id="23cb8b2c-1c23-8006-b10a-efe7a17bf1c0" class="bulleted-list"><li style="list-style-type:disc"><em><mark class="highlight-red">By default, Hubble does not redact potentially sensitive information present in Layer 7 Hubble Flows. ⇒ </mark></em><em><mark class="highlight-red"><strong>허블은 민감정보 직접 편집 X</strong></mark></em></li></ul><ul id="23cb8b2c-1c23-80f5-a5e2-fdd70c275928" class="bulleted-list"><li style="list-style-type:disc">간단 실습 따라해보기<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23cb8b2c-1c23-804c-a58d-e93960cf9430" class="code"><code class="language-Shell"># http 요청의 query_string에 user_id라는 민감 정보를 담아서 요청
kubectl exec -it curl-pod -- sh -c &#x27;curl -s webpod/?user_id=1234&#x27;

# hubble L7 monitoring에서 user_id를 log에서 확인 할 수 있다.
# 보안적으로 좋지않다. 
hubble observe -f -t l7
Jul 26 09:54:36.246: default/curl-pod:60346 (ID:1294) -&gt; default/webpod-697b545f57-4p672:80 (ID:12737) http-request FORWARDED (HTTP/1.1 GET http://webpod/?user_id=1234)
Jul 26 09:54:36.248: default/curl-pod:60346 (ID:1294) &lt;- default/webpod-697b545f57-4p672:80 (ID:12737) http-response FORWARDED (HTTP/1.1 200 2ms (GET http://webpod/?user_id=1234))

# 민감정보 미출력 설정
# --hubble-redact-enabled args로 redact enable하고
# --hubble-redact-http-urlquery와 같이 추가적으로 어떤 redact를 enable하여 log에서 보이지 않게 제거할지 설정할 수 있다.
helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values \
  --set extraArgs=&quot;{--hubble-redact-enabled,--hubble-redact-http-urlquery}&quot;

#
kubectl exec -it curl-pod -- sh -c &#x27;curl -s webpod/?user_id=1234&#x27;

# 이제 더이상 query_string에 담긴 user_id 정보가 log에 노출되지 않는다.
hubble observe -f -t l7
Jul 26 10:00:38.393: default/curl-pod:40591 (ID:1294) -&gt; kube-system/coredns-674b8bbfcf-pxmpk:53 (ID:18848) dns-request proxy FORWARDED (DNS Query webpod.default.svc.cluster.local. AAAA)
...
Jul 26 10:00:38.396: default/curl-pod:37494 (ID:1294) -&gt; default/webpod-697b545f57-4p672:80 (ID:12737) http-request FORWARDED (HTTP/1.1 GET http://webpod/)
Jul 26 10:00:38.399: default/curl-pod:37494 (ID:1294) &lt;- default/webpod-697b545f57-4p672:80 (ID:12737) http-response FORWARDED (HTTP/1.1 200 2ms (GET http://webpod/))</code></pre></li></ul><p id="23cb8b2c-1c23-8099-9de3-d50e131492fe" class="">
</p><ul id="23cb8b2c-1c23-803b-b8cf-da5c9f7a5920" class="bulleted-list"><li style="list-style-type:disc">보안을 강화하기 위해 Cilium은 허블이 레이어 7 흐름에 존재하는 민감한 정보를 <mark class="highlight-red"><strong>처리(제거나 마스킹)</strong></mark>할 수 있도록 <code>--hubble-redact-enabled</code> 옵션을 제공합니다. </li></ul><ul id="23cb8b2c-1c23-8041-98ad-e470d39a90b0" class="bulleted-list"><li style="list-style-type:disc">보다 구체적으로, 지원되는 레이어 7 프로토콜에 대해 다음과 같은 기능을 제공합니다:<ul id="23cb8b2c-1c23-80c7-9bce-c8614d7c2c4d" class="bulleted-list"><li style="list-style-type:circle">For <strong>HTTP</strong>: <strong>redacting URL query </strong>(GET) parameters (<code>--hubble-redact-http-urlquery</code>) <em>⇒ URL의 </em><em><code>?query=value</code></em><em> 부분 제거</em><ul id="23cb8b2c-1c23-80ac-9f8b-ca6dd9726a2b" class="bulleted-list"><li style="list-style-type:square">예시) 설정 전<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23cb8b2c-1c23-801e-b127-e1ca4989ba31" class="code"><code class="language-Bash">&quot;method&quot;: &quot;GET&quot;,
&quot;url&quot;: &quot;/user/profile?user_id=1234&amp;token=abcd1234&quot;,
&quot;status&quot;: 200</code></pre></li></ul><ul id="23cb8b2c-1c23-80db-81bd-d878bcec230a" class="bulleted-list"><li style="list-style-type:square">예시) 설정 후 : <code><strong>--set extraArgs=&quot;{--hubble-redact-http-urlquery}”</strong></code><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23cb8b2c-1c23-80b5-a888-d2802ae0d74f" class="code"><code class="language-Bash">&quot;method&quot;: &quot;GET&quot;,
&quot;url&quot;: &quot;/user/profile&quot;, # 쿼리 문자열이 제거되어 출력, 민감 정보 보호됨
&quot;status&quot;: 200</code></pre><p id="23cb8b2c-1c23-804d-98d7-ec01713976c2" class="">
</p></li></ul></li></ul><ul id="23cb8b2c-1c23-80a3-abcb-e7d7a6ad2222" class="bulleted-list"><li style="list-style-type:circle">For <strong>HTTP</strong>: <strong>redacting URL user info</strong> (for example, <strong>password</strong> used in basic auth) (<code>-hubble-redact-http-userinfo</code>)<p id="23cb8b2c-1c23-80a2-9a9a-ff0519839cf1" class=""><em>⇒ URL의 </em><em><code>user:pass@</code></em><em> 부분 제거</em></p></li></ul><ul id="23cb8b2c-1c23-80fd-acea-c4f493f079aa" class="bulleted-list"><li style="list-style-type:circle">For <strong>Kafka</strong>: <strong>redacting API key</strong> (<code>-hubble-redact-kafka-apikey</code>)</li></ul><ul id="23cb8b2c-1c23-801d-bac0-e09eb2855167" class="bulleted-list"><li style="list-style-type:circle">For <strong>HTTP headers</strong>: redacting all headers except those defined in the <code>-hubble-redact-http-headers-allow</code> list or redacting only the headers defined in the <code>-hubble-redact-http-headers-deny</code> list</li></ul></li></ul><ul id="23cb8b2c-1c23-802a-9a63-e32bf81fb40f" class="bulleted-list"><li style="list-style-type:disc">hubble-ui 상에서는 민감정보가 제거된 상태로 아래와 같이 보인다.<figure id="23cb8b2c-1c23-800f-bccb-ee44789d57eb" class="image"><a href="images/image%206.png"><img style="width:960px" src="images/image%206.png"/></a></figure></li></ul></details></li></ul><p id="23cb8b2c-1c23-8039-829f-cfb3f4ea9eea" class="">
</p><ol type="1" id="23cb8b2c-1c23-80d0-bee2-f9f5504f1bde" class="numbered-list" start="5"><li><strong>pwru</strong><ul id="23cb8b2c-1c23-80e6-bd96-e0cb88c6dfbc" class="bulleted-list"><li style="list-style-type:disc">Packet, where are you?<strong> eBPF-based Linux kernel networking debugger</strong> : <a href="https://github.com/cilium/pwru">https://github.com/cilium/pwru</a></li></ul><ul id="23cb8b2c-1c23-80a7-8000-ced1d04bfbbd" class="bulleted-list"><li style="list-style-type:disc"><a href="https://nuguni.tistory.com/97">https://nuguni.tistory.com/97</a></li></ul><ul id="23cb8b2c-1c23-80da-85c5-c134187e1bfe" class="bulleted-list"><li style="list-style-type:disc"><a href="https://cilium.io/blog/2023/03/22/packet-where-are-you/">https://cilium.io/blog/2023/03/22/packet-where-are-you/</a></li></ul><ul id="23cb8b2c-1c23-8071-a567-de68c4c61b50" class="toggle"><li><details open=""><summary><a href="https://medium.com/@Nikhil690/debugging-packet-drops-and-kernel-flows-with-pwru-fc03f3d479a4">https://medium.com/@Nikhil690/debugging-packet-drops-and-kernel-flows-with-pwru-fc03f3d479a4</a><em><mark class="highlight-red"> → mac M1(arm64 CPU)에서 pwru make(or 컨테이너 이미지도) 실패함…</mark></em></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23cb8b2c-1c23-8086-94ab-c93d23add185" class="code"><code class="language-Bash"># Prerequisites
sudo apt update
sudo apt install -y clang llvm gcc make flex bison byacc yacc libpcap-dev golang


# Building PWRU from Source
## Clone the PWRU GitHub repository
git clone https://github.com/cilium/pwru.git

## Navigate to the project directory
cd pwru

## Build the project : Compile the eBPF object files, Build the userspace Go application, Link everything together
make
...
gcc -fvisibility=hidden  -fpic -I.  -DBUILDING_PCAP -Dpcap_EXPORTS -DHAVE_CONFIG_H  -g -O2    -c ./pcap-linux.c
./pcap-linux.c: In function ‘pcap_breakloop_linux’:
./pcap-linux.c:948:23: warning: ignoring return value of ‘write’ declared with attribute ‘warn_unused_result’ [-Wunused-result]
  948 |                 (void)write(handlep-&gt;poll_breakloop_fd, &amp;value, sizeof(value));
      |                       ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
...
# runtime/cgo
cc: error: unrecognized command-line option &#x27;-m64&#x27;
make: *** [Makefile:22: pwru] Error 1


# Running PWRU
## Since PWRU interacts directly with kernel functions and eBPF subsystems, you need root permissions to run it:
sudo ./pwru [options] [pcap-filter]

## Usage
###  Let’s trace ICMP (ping) packets traveling through the kernel:
sudo ./pwru --output-tuple icmp
</code></pre><p id="23cb8b2c-1c23-805a-946d-c74f1d917839" class="">
</p></details></li></ul><ul id="23cb8b2c-1c23-805c-84e6-f6287ed0b6b6" class="bulleted-list"><li style="list-style-type:disc"><a href="https://blog.sflow.com/2025/07/tracing-network-packets-with-ebpf-and.html">https://blog.sflow.com/2025/07/tracing-network-packets-with-ebpf-and.html</a> <em><mark class="highlight-blue">→ mac Multipass 로 설치될듯.. 해보자~</mark></em></li></ul><ul id="23cb8b2c-1c23-80af-8b63-caaad72fe692" class="bulleted-list"><li style="list-style-type:disc"><code>도전과제5</code> pwru 설치 후 장애 재현 환경 구성 후 pwru 로 원인 파악해보기</li></ul></li></ol></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>